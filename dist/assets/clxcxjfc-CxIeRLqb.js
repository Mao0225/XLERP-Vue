import{O as A,P as Oe,Q as Pe,R as Le,_ as Ye,f as Je,k as Ae,r as s,g as Ie,s as Ge,h as f,G as He,o as v,c as y,a as V,b as l,w as r,F as Y,m as J,i as p,W as ne,H as Xe,l as Ke,q as W,p as ue,E as g,A as Ze,B as el}from"./index-DvIhe9Wx.js";import{a as ll}from"./file-dcKrrYHU.js";import{W as ie,S as se}from"./SupplierDialog-Bx03ZghE.js";import"./plshengchangongdan-xXUNx7N2.js";import"./basorg-BkZ2EbOy.js";function tl(w){return A("/clxcxjfc/getpage",w)}function al(w){return A("/clxcxjfc/get",w)}function ol(w){return Oe("/clxcxjfc/save",w)}function rl(w){return Pe("/clxcxjfc/update",w)}function nl(w){return Le("/clxcxjfc/delete",w)}function ul(w){return A("/clxcxjfc/getGongdanByWoNo",w)}const il={class:"clxcxjfc-management"},sl={class:"action-bar"},dl={key:0},pl={key:1},cl=["onClick"],ml={class:"pagination-container"},fl={key:0,class:"el-form-item__error"},vl={key:0,class:"uploaded-files"},gl={key:0,class:"preview-container"},yl=["src"],wl={key:1,class:"preview-container"},bl=["src"],Vl=["href"],Nl={key:2,class:"preview-container"},xl={style:{"text-align":"center",padding:"40px"}},kl={__name:"clxcxjfc",setup(w){const de=Je(),I=Ae(()=>({username:de.realName||"未登录"})),_=el,pe=["紧固件","预绞丝"],ce={紧固件:"锌层厚度（紧固件适用）：μm",预绞丝:"抗拉强度（预绞丝适用）：MPa"},o=s(M()),u=Ie({maQuality:"",mafactory:"",woNo:"",pageNumber:1,pageSize:10}),G=s([]),H=s(0),B=s(!1),C=s(!1),E=s("新增悬垂线夹辅材"),h=s("add"),j=s(null),O=s(!1),T=s(!1),U=s(!1),$=s(!1),D=s(!1),R=s(!1),P=s(null),N=s([]),F=s(!1),x=s(""),z=s(""),q=s("");function X(a){if(!a)return[];try{const e=JSON.parse(a);return Array.isArray(e)?e.map(n=>({...n,url:n.url.startsWith("http")?n.url:_+n.url})):[]}catch{return console.warn("Failed to parse certificate JSON for display:",a),[]}}function K(a){if(!a)return"";const e=a.match(/(-?\d+(\.\d+)?)/);if(e){const n=Math.round(Number(e[1]));return a.replace(/(-?\d+(\.\d+)?)/,n)}return a}const me=()=>{if(o.value.testResult){const a=o.value.testResult,e=K(a),n=a.match(/(-?\d+(\.\d+)?)/),i=e.match(/(-?\d+)/);n&&i&&n[0]!==i[0]&&n[2]?T.value=!0:T.value=!1,o.value.testResult=e}},Z=(a,e="")=>{const n=a||e;return/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?"image":/\.pdf$/i.test(n)?"pdf":"other"},fe=a=>{const e=Z(a.url,a.name);e==="image"||e==="pdf"?ve(a.url,a.name,e):L(a.url,a.name)},ve=(a,e="",n="")=>{const i=a.startsWith("http")?a:_+a;x.value=i,q.value=e,z.value=n||Z(i,e),F.value=!0},L=(a,e="")=>{try{const n=a.startsWith("http")?a:_+a,i=document.createElement("a");i.href=n,i.download=e||"质量证明书",i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i),g.success("文件下载已开始")}catch(n){console.error("下载文件失败:",n),g.error("文件下载失败，请稍后重试"),window.open(a.startsWith("http")?a:_+a,"_blank")}},ee=()=>{F.value=!1,x.value="",q.value="",z.value=""},ge=()=>{g.error("图片加载失败")},ye=()=>{g.error("PDF预览失败，请尝试下载文件")},we=async a=>{if(N.value.length>=3){g.warning("最多只能上传3个质量证明书"),P.value.clearFiles();return}const e=new FormData;e.append("file",a.raw);try{const n=await ll(e);if(n.success&&n.data&&n.data.url){const i=_+n.data.url,d=JSON.parse(o.value.certificate||"[]");d.push({name:a.name,url:i}),o.value.certificate=JSON.stringify(d),N.value.push({name:a.name,url:i}),g.success(`${a.name} 上传成功`)}else throw new Error(n.msg||"文件上传失败")}catch(n){console.error("文件上传失败",n),g.error(`${a.name} 上传失败`),P.value.clearFiles()}},be=a=>{const e=JSON.parse(o.value.certificate||"[]");e.splice(a,1),o.value.certificate=JSON.stringify(e),N.value.splice(a,1)};function M(){return{id:void 0,maQuality:"",matRecheckNo:"",orderno:"",mafactory:"",sampleNumber:"",testResult:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",contractNo:"",woNo:"",ipoNo:"",writer:"",writeTime:"",flag:"",status:"",memo:"",type:""}}const Ve={maQuality:[{required:!0,message:"请选择辅材类型",trigger:"change"}],matRecheckNo:[{required:!0,message:"请填写来料检验批次号",trigger:"blur"}],orderno:[{required:!0,message:"请填写入库单号",trigger:"blur"}],mafactory:[{required:!0,message:"请选择原材料制造商",trigger:"change"}],sampleNumber:[{required:!0,message:"请填写样品编号",trigger:"blur"}],testResult:[{required:!0,message:"请填写检测结果",trigger:"blur"}],leavefactoryDate:[{required:!0,message:"请选择原材料出厂检测日期",trigger:"change"}],detectionTime:[{required:!0,message:"请选择原材料入厂检测日期",trigger:"change"}],certificate:[{required:!0,message:"请上传质量证明书",trigger:"change"}],woNo:[{required:!0,message:"请选择生产工单号",trigger:"change"}],contractNo:[{required:!0,message:"合同编号不能为空",trigger:"change"}],ipoNo:[{required:!0,message:"生产订单号不能为空",trigger:"change"}],writer:[{required:!0,message:"录入人不能为空",trigger:"blur"}]},S=async()=>{B.value=!0;try{const a=await tl(u);G.value=a.data.page.list,H.value=a.data.page.totalRow}catch{g.error("获取数据失败")}finally{B.value=!1}},Q=()=>{u.maQuality="",u.mafactory="",u.woNo="",u.pageNumber=1,S()},Ne=a=>{u.pageSize=a,S()},xe=a=>{u.pageNumber=a,S()},ke=()=>{E.value="新增悬垂线夹辅材",h.value="add",o.value=M(),o.value.writer=I.value.username,o.value.writeTime=te(new Date),N.value=[],o.value.certificate="[]",C.value=!0},Ce=async a=>{E.value="编辑悬垂线夹辅材",h.value="edit";try{const e=await al({id:a.id});e&&e.code===200&&e.data&&e.data.clXcxjFc&&(o.value={...M(),...e.data.clXcxjFc}),N.value=X(o.value.certificate),C.value=!0}catch(e){console.error("获取详情失败",e)}},Se=a=>{Ze.confirm("确认删除该条辅材数据吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{await nl({id:a.id}),g.success("删除成功"),Q()}).catch(()=>{})},_e=a=>{(h.value==="add"||h.value==="edit")&&(o.value.testResult=ce[a]||"")},le=()=>{$.value=!0},he=a=>{u.mafactory=a,U.value=!1},Ue=a=>{u.woNo=a.woNo,R.value=!1},De=()=>{u.mafactory=""},Re=()=>{u.woNo=""},Fe=a=>{o.value.mafactory=a,D.value=!1},je=async a=>{o.value.woNo=a.woNo;try{const{data:e}=await ul({woNo:a.woNo});o.value.contractNo=(e==null?void 0:e.contractNo)||"",o.value.ipoNo=(e==null?void 0:e.ipoNo)||"",(!o.value.contractNo||!o.value.ipoNo)&&g.warning("未能从工单获取合同编号或订单号，请确认工单数据")}catch{o.value.contractNo="",o.value.ipoNo="",g.error("获取工单详情失败，请联系管理员或检查接口")}$.value=!1},Te=()=>{j.value.validate(async a=>{if(a){O.value=!0;try{o.value.certificate=JSON.stringify(N.value),h.value==="add"?(o.value.writer=I.value.username,o.value.writeTime=te(new Date),await ol(o.value),g.success("新增成功"),Q()):(await rl(o.value),g.success("修改成功"),Q()),C.value=!1}catch(e){console.error("保存失败:",e),g.error("保存失败: "+(e.message||e))}finally{O.value=!1}}})};function te(a){if(!a)return"";const e=new Date(a),n=i=>i.toString().padStart(2,"0");return`${e.getFullYear()}-${n(e.getMonth()+1)}-${n(e.getDate())} ${n(e.getHours())}:${n(e.getMinutes())}:${n(e.getSeconds())}`}const $e=()=>{o.value=M(),N.value=[],ee(),j.value&&j.value.resetFields(),T.value=!1};return Ge(S),(a,e)=>{const n=f("el-option"),i=f("el-select"),d=f("el-button"),b=f("el-input"),c=f("el-table-column"),ze=f("el-table"),qe=f("el-pagination"),m=f("el-form-item"),ae=f("el-date-picker"),Me=f("el-upload"),Qe=f("el-form"),oe=f("el-dialog"),We=f("Document"),Be=f("el-icon"),Ee=He("loading");return v(),y("div",il,[V("div",sl,[l(i,{modelValue:u.maQuality,"onUpdate:modelValue":e[0]||(e[0]=t=>u.maQuality=t),placeholder:"辅材类型",style:{width:"140px","margin-right":"10px"},clearable:"",onChange:S},{default:r(()=>[(v(),y(Y,null,J(pe,t=>l(n,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),l(b,{modelValue:u.mafactory,"onUpdate:modelValue":e[2]||(e[2]=t=>u.mafactory=t),placeholder:"原材料制造商",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[3]||(e[3]=ne(t=>U.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:De},{append:r(()=>[l(d,{onClick:e[1]||(e[1]=t=>U.value=!0),size:"small"},{default:r(()=>e[33]||(e[33]=[p("选择")])),_:1})]),_:1},8,["modelValue"]),l(b,{modelValue:u.woNo,"onUpdate:modelValue":e[5]||(e[5]=t=>u.woNo=t),placeholder:"生产工单号",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[6]||(e[6]=ne(t=>R.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:Re},{append:r(()=>[l(d,{onClick:e[4]||(e[4]=t=>R.value=!0),size:"small"},{default:r(()=>e[34]||(e[34]=[p("选择")])),_:1})]),_:1},8,["modelValue"]),l(d,{type:"primary",onClick:S},{default:r(()=>e[35]||(e[35]=[p("搜索")])),_:1}),l(d,{type:"warning",onClick:Q,style:{"margin-left":"10px"}},{default:r(()=>e[36]||(e[36]=[p("重置")])),_:1}),l(d,{type:"primary",style:{"margin-left":"auto"},onClick:ke},{default:r(()=>e[37]||(e[37]=[p("新增悬垂线夹辅材")])),_:1})]),Xe((v(),Ke(ze,{data:G.value,border:"",style:{width:"100%"}},{default:r(()=>[l(c,{type:"index",label:"序号",width:"70"}),l(c,{prop:"maQuality",label:"辅材类型"}),l(c,{prop:"matRecheckNo",label:"来料检验批次号"}),l(c,{prop:"orderno",label:"入库单号"}),l(c,{prop:"mafactory",label:"原材料制造商"}),l(c,{prop:"sampleNumber",label:"样品编号"}),l(c,{prop:"testResult",label:"检测结果"},{default:r(({row:t})=>[t.maQuality==="紧固件"||t.maQuality==="预绞丝"?(v(),y("span",dl,W(K(t.testResult)),1)):(v(),y("span",pl,W(t.testResult),1))]),_:1}),l(c,{prop:"leavefactoryDate",label:"原材料出厂检测日期",width:"130"}),l(c,{prop:"detectionTime",label:"原材料入厂检测日期",width:"130"}),l(c,{label:"质量证明书"},{default:r(({row:t})=>[(v(!0),y(Y,null,J(X(t.certificate),(k,re)=>(v(),y("div",{key:re},[V("span",{class:"file-link",onClick:Cl=>fe(k)},W(k.name),9,cl)]))),128))]),_:1}),l(c,{prop:"contractNo",label:"合同编号"}),l(c,{prop:"woNo",label:"生产工单号"}),l(c,{prop:"ipoNo",label:"生产订单号"}),l(c,{prop:"writer",label:"录入人"}),l(c,{prop:"writeTime",label:"录入时间",width:"150"}),l(c,{label:"操作",width:"220",fixed:"right"},{default:r(({row:t})=>[l(d,{type:"primary",size:"small",onClick:k=>Ce(t)},{default:r(()=>e[38]||(e[38]=[p("编辑")])),_:2},1032,["onClick"]),l(d,{type:"danger",size:"small",onClick:k=>Se(t)},{default:r(()=>e[39]||(e[39]=[p("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ee,B.value]]),V("div",ml,[l(qe,{"current-page":u.pageNumber,"onUpdate:currentPage":e[7]||(e[7]=t=>u.pageNumber=t),"page-size":u.pageSize,"onUpdate:pageSize":e[8]||(e[8]=t=>u.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:H.value,onSizeChange:Ne,onCurrentChange:xe},null,8,["current-page","page-size","total"])]),l(oe,{title:E.value,modelValue:C.value,"onUpdate:modelValue":e[26]||(e[26]=t=>C.value=t),width:"700px",onClosed:$e},{footer:r(()=>[l(d,{onClick:e[23]||(e[23]=t=>C.value=!1)},{default:r(()=>e[46]||(e[46]=[p("取消")])),_:1}),l(d,{type:"primary",onClick:Te,loading:O.value},{default:r(()=>e[47]||(e[47]=[p("保存")])),_:1},8,["loading"])]),default:r(()=>[l(Qe,{ref_key:"formRef",ref:j,model:o.value,rules:Ve,"label-width":"120px"},{default:r(()=>[l(m,{label:"生产工单号",prop:"woNo"},{default:r(()=>[l(b,{modelValue:o.value.woNo,"onUpdate:modelValue":e[9]||(e[9]=t=>o.value.woNo=t),placeholder:"请选择生产工单号",readonly:"",style:{width:"calc(100% - 80px)"},onClick:le},{append:r(()=>[l(d,{onClick:le,size:"small"},{default:r(()=>e[40]||(e[40]=[p("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(m,{label:"合同编号",prop:"contractNo"},{default:r(()=>[l(b,{modelValue:o.value.contractNo,"onUpdate:modelValue":e[10]||(e[10]=t=>o.value.contractNo=t),disabled:""},null,8,["modelValue"])]),_:1}),l(m,{label:"生产订单号",prop:"ipoNo"},{default:r(()=>[l(b,{modelValue:o.value.ipoNo,"onUpdate:modelValue":e[11]||(e[11]=t=>o.value.ipoNo=t),disabled:""},null,8,["modelValue"])]),_:1}),l(m,{label:"辅材类型",prop:"maQuality"},{default:r(()=>[l(i,{modelValue:o.value.maQuality,"onUpdate:modelValue":e[12]||(e[12]=t=>o.value.maQuality=t),placeholder:"请选择辅材类型",style:{width:"100%"},onChange:_e},{default:r(()=>[l(n,{label:"紧固件",value:"紧固件"}),l(n,{label:"预绞丝",value:"预绞丝"})]),_:1},8,["modelValue"])]),_:1}),l(m,{label:"来料检验批次号",prop:"matRecheckNo"},{default:r(()=>[l(b,{modelValue:o.value.matRecheckNo,"onUpdate:modelValue":e[13]||(e[13]=t=>o.value.matRecheckNo=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(m,{label:"入库单号",prop:"orderno"},{default:r(()=>[l(b,{modelValue:o.value.orderno,"onUpdate:modelValue":e[14]||(e[14]=t=>o.value.orderno=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(m,{label:"原材料制造商",prop:"mafactory"},{default:r(()=>[l(b,{modelValue:o.value.mafactory,"onUpdate:modelValue":e[16]||(e[16]=t=>o.value.mafactory=t),placeholder:"请选择原材料制造商",readonly:"",style:{cursor:"pointer"},onClick:D.value},{append:r(()=>[l(d,{onClick:e[15]||(e[15]=t=>D.value=!0),size:"small"},{default:r(()=>e[41]||(e[41]=[p("选择")])),_:1})]),_:1},8,["modelValue","onClick"])]),_:1}),l(m,{label:"样品编号",prop:"sampleNumber"},{default:r(()=>[l(b,{modelValue:o.value.sampleNumber,"onUpdate:modelValue":e[17]||(e[17]=t=>o.value.sampleNumber=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(m,{label:"检测结果",prop:"testResult"},{default:r(()=>[l(b,{modelValue:o.value.testResult,"onUpdate:modelValue":e[18]||(e[18]=t=>o.value.testResult=t),maxlength:"100",type:"textarea",rows:2,placeholder:"请输入检测结果",onBlur:me},null,8,["modelValue"]),e[42]||(e[42]=V("div",{class:"el-form-item__tip"},"提示：数值部分将自动四舍五入为整数",-1)),T.value?(v(),y("div",fl,"检测结果中的数值应保留0位小数，已自动四舍五入")):ue("",!0)]),_:1}),l(m,{label:"原材料出厂检测日期",prop:"leavefactoryDate"},{default:r(()=>[l(ae,{modelValue:o.value.leavefactoryDate,"onUpdate:modelValue":e[19]||(e[19]=t=>o.value.leavefactoryDate=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(m,{label:"原材料入厂检测日期",prop:"detectionTime"},{default:r(()=>[l(ae,{modelValue:o.value.detectionTime,"onUpdate:modelValue":e[20]||(e[20]=t=>o.value.detectionTime=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(m,{label:"质量证明书",prop:"certificate"},{default:r(()=>[l(Me,{ref_key:"certificateUpload",ref:P,"auto-upload":!1,"on-change":we,limit:3,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png","file-list":[],"show-file-list":!1},{default:r(()=>[l(d,{type:"primary"},{default:r(()=>e[43]||(e[43]=[p("上传质量证明书")])),_:1}),e[44]||(e[44]=V("div",{class:"el-upload__tip"},"支持 pdf、doc、docx、xls、xlsx、jpg、jpeg、png 等格式，最多3个质量证明书",-1))]),_:1},512),o.value.certificate?(v(),y("div",vl,[(v(!0),y(Y,null,J(JSON.parse(o.value.certificate),(t,k)=>(v(),y("div",{key:k,class:"uploaded-file"},[p(W(t.name)+" ",1),l(d,{type:"danger",size:"mini",onClick:re=>be(k)},{default:r(()=>e[45]||(e[45]=[p("删除")])),_:2},1032,["onClick"])]))),128))])):ue("",!0)]),_:1}),l(m,{label:"录入人",prop:"writer"},{default:r(()=>[l(b,{modelValue:o.value.writer,"onUpdate:modelValue":e[21]||(e[21]=t=>o.value.writer=t),disabled:""},null,8,["modelValue"])]),_:1}),l(m,{label:"录入时间",prop:"writeTime"},{default:r(()=>[l(b,{modelValue:o.value.writeTime,"onUpdate:modelValue":e[22]||(e[22]=t=>o.value.writeTime=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),l(ie,{modelValue:$.value,"onUpdate:modelValue":e[24]||(e[24]=t=>$.value=t),onSelect:je},null,8,["modelValue"]),l(se,{modelValue:D.value,"onUpdate:modelValue":e[25]||(e[25]=t=>D.value=t),onSelect:Fe},null,8,["modelValue"])]),_:1},8,["title","modelValue"]),l(oe,{title:"质量证明书预览",modelValue:F.value,"onUpdate:modelValue":e[30]||(e[30]=t=>F.value=t),width:"80%","close-on-click-modal":!1,"before-close":ee},{footer:r(()=>[l(d,{onClick:e[28]||(e[28]=t=>F.value=!1)},{default:r(()=>e[51]||(e[51]=[p("关闭")])),_:1}),l(d,{type:"primary",onClick:e[29]||(e[29]=t=>L(x.value,q.value))},{default:r(()=>e[52]||(e[52]=[p(" 下载 ")])),_:1})]),default:r(()=>[z.value==="image"?(v(),y("div",gl,[V("img",{src:x.value,alt:"质量证明书",style:{"max-width":"100%","max-height":"70vh",display:"block",margin:"0 auto"},onError:ge},null,40,yl)])):z.value==="pdf"?(v(),y("div",wl,[V("iframe",{src:x.value,width:"100%",height:"600px",frameborder:"0",onError:ye},[e[48]||(e[48]=p(" 您的浏览器不支持PDF预览，请")),V("a",{href:x.value,target:"_blank"},"点击此处下载",8,Vl)],40,bl)])):(v(),y("div",Nl,[V("div",xl,[l(Be,{size:"64",color:"#909399"},{default:r(()=>[l(We)]),_:1}),e[50]||(e[50]=V("p",{style:{margin:"20px 0",color:"#606266"}},"此文件类型不支持在线预览",-1)),l(d,{type:"primary",onClick:e[27]||(e[27]=t=>L(x.value,q.value))},{default:r(()=>e[49]||(e[49]=[p(" 下载文件 ")])),_:1})])]))]),_:1},8,["modelValue"]),l(ie,{modelValue:R.value,"onUpdate:modelValue":e[31]||(e[31]=t=>R.value=t),onSelect:Ue},null,8,["modelValue"]),l(se,{modelValue:U.value,"onUpdate:modelValue":e[32]||(e[32]=t=>U.value=t),onSelect:he},null,8,["modelValue"])])}}},Rl=Ye(kl,[["__scopeId","data-v-7d498c3a"]]);export{Rl as default};

import{O as Y,P as je,Q as Te,R as We,_ as Fe,f as Re,k as qe,r as d,g as Ee,s as Me,h as f,G as Be,o as v,c as y,a as b,b as l,e as Pe,w as r,i as s,W as ee,H as Le,l as Ye,q as F,F as le,m as te,p as Oe,x as Je,ah as Ae,E as m,A as Ie,B as Ge}from"./index-DvIhe9Wx.js";import{a as He}from"./file-dcKrrYHU.js";import{W as ae,S as oe}from"./SupplierDialog-Bx03ZghE.js";import"./plshengchangongdan-xXUNx7N2.js";import"./basorg-BkZ2EbOy.js";function Ke(g){return Y("/clnzxjlbgx/getpage",g)}function Qe(g){return Y("/clnzxjlbgx/get",g)}function Xe(g){return je("/clnzxjlbgx/save",g)}function Ze(g){return Te("/clnzxjlbgx/update",g)}function el(g){return We("/clnzxjlbgx/delete",g)}function ll(g){return Y("/clnzxjlbgx/getGongdanByWoNo",g)}const tl={class:"clnzxjlbgx-management"},al={class:"action-bar"},ol=["onClick"],rl={class:"pagination-container"},nl={key:0,class:"uploaded-files"},il={key:0,class:"preview-container"},ul=["src"],sl={key:1,class:"preview-container"},dl=["src"],pl=["href"],ml={key:2,class:"preview-container"},cl={style:{"text-align":"center",padding:"40px"}},gl={__name:"clnzxjlbgx",setup(g){const re=Re(),O=qe(()=>({username:re.realName||"未登录"})),C=Ge,o=d(T()),u=Ee({matRecheckNo:"",mafactory:"",woNo:"",pageNumber:1,pageSize:10}),J=d([]),A=d(0),R=d(!1),N=d(!1),q=d("新增耐张线夹铝包钢线"),E=d("add"),D=d(null),M=d(!1),S=d(!1),_=d(!1),z=d(!1),h=d(!1),B=d(null),w=d([]),U=d(!1),x=d(""),$=d(""),j=d("");function P(a){if(!a)return[];try{const e=JSON.parse(a);return Array.isArray(e)?e.map(n=>({...n,url:n.url.startsWith("http")?n.url:C+n.url})):[]}catch{return console.warn("Failed to parse certificate JSON for display:",a),[]}}const I=(a,e="")=>{const n=a||e;return/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?"image":/\.pdf$/i.test(n)?"pdf":"other"},ne=a=>{const e=I(a.url,a.name);e==="image"||e==="pdf"?ie(a.url,a.name,e):L(a.url,a.name)},ie=(a,e="",n="")=>{const i=a.startsWith("http")?a:C+a;x.value=i,j.value=e,$.value=n||I(i,e),U.value=!0},L=(a,e="")=>{try{const n=a.startsWith("http")?a:C+a,i=document.createElement("a");i.href=n,i.download=e||"质量证明书",i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i),m.success("文件下载已开始")}catch(n){console.error("下载文件失败:",n),m.error("文件下载失败，请稍后重试"),window.open(a.startsWith("http")?a:C+a,"_blank")}},G=()=>{U.value=!1,x.value="",j.value="",$.value=""},ue=()=>{m.error("图片加载失败")},se=()=>{m.error("PDF预览失败，请尝试下载文件")},de=async a=>{if(w.value.length>=3){m.warning("最多只能上传3个质量证明书"),B.value.clearFiles();return}const e=new FormData;e.append("file",a.raw);try{const n=await He(e);if(n.success&&n.data&&n.data.url){const i=C+n.data.url,p=JSON.parse(o.value.certificate||"[]");p.push({name:a.name,url:i}),o.value.certificate=JSON.stringify(p),w.value.push({name:a.name,url:i}),m.success(`${a.name} 上传成功`)}else throw new Error(n.msg||"文件上传失败")}catch(n){console.error("文件上传失败",n),m.error(`${a.name} 上传失败`),B.value.clearFiles()}},pe=a=>{const e=JSON.parse(o.value.certificate||"[]");e.splice(a,1),o.value.certificate=JSON.stringify(e),w.value.splice(a,1)};function T(){return{id:void 0,matRecheckNo:"",orderno:"",size:"",singleWireStrength:"",mafactory:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",contractNo:"",woNo:"",ipoNo:"",writer:"",writeTime:"",flag:"",status:"",memo:"",type:""}}const me={matRecheckNo:[{required:!0,message:"请填写来料检验批次号",trigger:"blur"}],orderno:[{required:!0,message:"请填写入库单号",trigger:"blur"}],size:[{required:!0,message:"请填写尺寸",trigger:"blur"}],singleWireStrength:[{required:!0,message:"请填写力学性能-单丝强度",trigger:"blur"}],mafactory:[{required:!0,message:"请选择原材料制造商",trigger:"change"}],leavefactoryDate:[{required:!0,message:"请选择原材料出厂检测日期",trigger:"change"}],detectionTime:[{required:!0,message:"请选择原材料入厂检测日期",trigger:"change"}],certificate:[{required:!0,message:"请上传质量证明书",trigger:"change"}],woNo:[{required:!0,message:"请选择生产工单号",trigger:"change"}],contractNo:[{required:!0,message:"合同编号不能为空",trigger:"change"}],ipoNo:[{required:!0,message:"生产订单号不能为空",trigger:"change"}],writer:[{required:!0,message:"录入人不能为空",trigger:"blur"}]},k=async()=>{R.value=!0;try{const a=await Ke(u);J.value=a.data.page.list,A.value=a.data.page.totalRow}catch{m.error("获取数据失败")}finally{R.value=!1}},W=()=>{u.matRecheckNo="",u.mafactory="",u.woNo="",u.pageNumber=1,k()},ce=a=>{u.pageSize=a,k()},ge=a=>{u.pageNumber=a,k()},fe=()=>{q.value="新增耐张线夹铝包钢线",E.value="add",o.value=T(),o.value.writer=O.value.username,o.value.writeTime=K(new Date),w.value=[],o.value.certificate="[]",N.value=!0},ve=async a=>{q.value="编辑耐张线夹铝包钢线",E.value="edit";try{const e=await Qe({id:a.id});e&&e.code===200&&e.data&&e.data.clNzxjLbgx&&(o.value={...T(),...e.data.clNzxjLbgx}),w.value=P(o.value.certificate),N.value=!0}catch(e){console.error("获取详情失败",e)}},ye=a=>{Ie.confirm("确认删除该条铝包钢线数据吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{await el({id:a.id}),m.success("删除成功"),W()}).catch(()=>{})},H=()=>{_.value=!0},be=a=>{u.mafactory=a,S.value=!1},we=a=>{u.woNo=a.woNo,h.value=!1},xe=()=>{u.mafactory=""},Ve=()=>{u.woNo=""},Ne=a=>{o.value.mafactory=a,z.value=!1},ke=async a=>{o.value.woNo=a.woNo;try{const{data:e}=await ll({woNo:a.woNo});o.value.contractNo=(e==null?void 0:e.contractNo)||"",o.value.ipoNo=(e==null?void 0:e.ipoNo)||"",(!o.value.contractNo||!o.value.ipoNo)&&m.warning("未能从工单获取合同编号或订单号，请确认工单数据")}catch{o.value.contractNo="",o.value.ipoNo="",m.error("获取工单详情失败，请联系管理员或检查接口")}_.value=!1},Ce=()=>{D.value.validate(async a=>{if(a){M.value=!0;try{o.value.certificate=JSON.stringify(w.value),E.value==="add"?(o.value.writer=O.value.username,o.value.writeTime=K(new Date),await Xe(o.value),m.success("新增成功"),W()):(await Ze(o.value),m.success("修改成功"),W()),N.value=!1}catch(e){console.error("保存失败:",e),m.error("保存失败: "+(e.message||e))}finally{M.value=!1}}})};function K(a){if(!a)return"";const e=new Date(a),n=i=>i.toString().padStart(2,"0");return`${e.getFullYear()}-${n(e.getMonth()+1)}-${n(e.getDate())} ${n(e.getHours())}:${n(e.getMinutes())}:${n(e.getSeconds())}`}const Se=()=>{o.value=T(),w.value=[],G(),D.value&&D.value.resetFields()};return Me(k),(a,e)=>{const n=f("el-input"),i=f("el-button"),p=f("el-table-column"),ze=f("el-table"),he=f("el-pagination"),c=f("el-form-item"),Q=f("el-date-picker"),Ue=f("el-upload"),De=f("el-form"),X=f("el-dialog"),_e=f("el-icon"),$e=Be("loading");return v(),y("div",tl,[b("div",al,[l(n,{modelValue:u.matRecheckNo,"onUpdate:modelValue":e[0]||(e[0]=t=>u.matRecheckNo=t),placeholder:"来料检验批次号",style:{width:"200px","margin-right":"10px"},clearable:"",onKeyup:Pe(k,["enter"])},null,8,["modelValue"]),l(n,{modelValue:u.mafactory,"onUpdate:modelValue":e[2]||(e[2]=t=>u.mafactory=t),placeholder:"原材料制造商",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[3]||(e[3]=ee(t=>S.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:xe},{append:r(()=>[l(i,{onClick:e[1]||(e[1]=t=>S.value=!0),size:"small"},{default:r(()=>e[32]||(e[32]=[s("选择")])),_:1})]),_:1},8,["modelValue"]),l(n,{modelValue:u.woNo,"onUpdate:modelValue":e[5]||(e[5]=t=>u.woNo=t),placeholder:"生产工单号",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[6]||(e[6]=ee(t=>h.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:Ve},{append:r(()=>[l(i,{onClick:e[4]||(e[4]=t=>h.value=!0),size:"small"},{default:r(()=>e[33]||(e[33]=[s("选择")])),_:1})]),_:1},8,["modelValue"]),l(i,{type:"primary",onClick:k},{default:r(()=>e[34]||(e[34]=[s("搜索")])),_:1}),l(i,{type:"warning",onClick:W,style:{"margin-left":"10px"}},{default:r(()=>e[35]||(e[35]=[s("重置")])),_:1}),l(i,{type:"primary",style:{"margin-left":"auto"},onClick:fe},{default:r(()=>e[36]||(e[36]=[s("新增耐张线夹铝包钢线")])),_:1})]),Le((v(),Ye(ze,{data:J.value,border:"",style:{width:"100%"}},{default:r(()=>[l(p,{type:"index",label:"序号",width:"70"}),l(p,{prop:"matRecheckNo",label:"来料检验批次号"}),l(p,{prop:"orderno",label:"入库单号"}),l(p,{prop:"size",label:"尺寸"},{default:r(({row:t})=>[s(F(t.size?`${t.size} mm`:""),1)]),_:1}),l(p,{prop:"singleWireStrength",label:"力学性能-单丝强度"},{default:r(({row:t})=>[s(F(t.singleWireStrength?`${t.singleWireStrength} MPa`:""),1)]),_:1}),l(p,{prop:"mafactory",label:"原材料制造商"}),l(p,{prop:"leavefactoryDate",label:"原材料出厂检测日期",width:"130"}),l(p,{prop:"detectionTime",label:"原材料入厂检测日期",width:"130"}),l(p,{label:"质量证明书"},{default:r(({row:t})=>[(v(!0),y(le,null,te(P(t.certificate),(V,Z)=>(v(),y("div",{key:Z},[b("span",{class:"file-link",onClick:fl=>ne(V)},F(V.name),9,ol)]))),128))]),_:1}),l(p,{prop:"contractNo",label:"合同编号"}),l(p,{prop:"woNo",label:"生产工单号"}),l(p,{prop:"ipoNo",label:"生产订单号"}),l(p,{prop:"writer",label:"录入人"}),l(p,{prop:"writeTime",label:"录入时间",width:"150"}),l(p,{label:"操作",width:"220",fixed:"right"},{default:r(({row:t})=>[l(i,{type:"primary",size:"small",onClick:V=>ve(t)},{default:r(()=>e[37]||(e[37]=[s("编辑")])),_:2},1032,["onClick"]),l(i,{type:"danger",size:"small",onClick:V=>ye(t)},{default:r(()=>e[38]||(e[38]=[s("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[$e,R.value]]),b("div",rl,[l(he,{"current-page":u.pageNumber,"onUpdate:currentPage":e[7]||(e[7]=t=>u.pageNumber=t),"page-size":u.pageSize,"onUpdate:pageSize":e[8]||(e[8]=t=>u.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:A.value,onSizeChange:ce,onCurrentChange:ge},null,8,["current-page","page-size","total"])]),l(X,{title:q.value,modelValue:N.value,"onUpdate:modelValue":e[25]||(e[25]=t=>N.value=t),width:"700px",onClosed:Se},{footer:r(()=>[l(i,{onClick:e[22]||(e[22]=t=>N.value=!1)},{default:r(()=>e[44]||(e[44]=[s("取消")])),_:1}),l(i,{type:"primary",onClick:Ce,loading:M.value},{default:r(()=>e[45]||(e[45]=[s("保存")])),_:1},8,["loading"])]),default:r(()=>[l(De,{ref_key:"formRef",ref:D,model:o.value,rules:me,"label-width":"120px"},{default:r(()=>[l(c,{label:"生产工单号",prop:"woNo"},{default:r(()=>[l(n,{modelValue:o.value.woNo,"onUpdate:modelValue":e[9]||(e[9]=t=>o.value.woNo=t),placeholder:"请选择生产工单号",readonly:"",style:{width:"calc(100% - 80px)"},onClick:H},{append:r(()=>[l(i,{onClick:H,size:"small"},{default:r(()=>e[39]||(e[39]=[s("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"合同编号",prop:"contractNo"},{default:r(()=>[l(n,{modelValue:o.value.contractNo,"onUpdate:modelValue":e[10]||(e[10]=t=>o.value.contractNo=t),disabled:""},null,8,["modelValue"])]),_:1}),l(c,{label:"生产订单号",prop:"ipoNo"},{default:r(()=>[l(n,{modelValue:o.value.ipoNo,"onUpdate:modelValue":e[11]||(e[11]=t=>o.value.ipoNo=t),disabled:""},null,8,["modelValue"])]),_:1}),l(c,{label:"来料检验批次号",prop:"matRecheckNo"},{default:r(()=>[l(n,{modelValue:o.value.matRecheckNo,"onUpdate:modelValue":e[12]||(e[12]=t=>o.value.matRecheckNo=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(c,{label:"入库单号",prop:"orderno"},{default:r(()=>[l(n,{modelValue:o.value.orderno,"onUpdate:modelValue":e[13]||(e[13]=t=>o.value.orderno=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(c,{label:"尺寸（mm）",prop:"size"},{default:r(()=>[l(n,{modelValue:o.value.size,"onUpdate:modelValue":e[14]||(e[14]=t=>o.value.size=t),maxlength:"50",placeholder:"请输入尺寸(mm)"},null,8,["modelValue"])]),_:1}),l(c,{label:"力学性能-单丝强度（MPa）",prop:"singleWireStrength"},{default:r(()=>[l(n,{modelValue:o.value.singleWireStrength,"onUpdate:modelValue":e[15]||(e[15]=t=>o.value.singleWireStrength=t),maxlength:"50",placeholder:"请输入单丝强度(MPa)"},null,8,["modelValue"])]),_:1}),l(c,{label:"原材料制造商",prop:"mafactory"},{default:r(()=>[l(n,{modelValue:o.value.mafactory,"onUpdate:modelValue":e[17]||(e[17]=t=>o.value.mafactory=t),placeholder:"请选择原材料制造商",readonly:"",style:{cursor:"pointer"},onClick:z.value},{append:r(()=>[l(i,{onClick:e[16]||(e[16]=t=>z.value=!0),size:"small"},{default:r(()=>e[40]||(e[40]=[s("选择")])),_:1})]),_:1},8,["modelValue","onClick"])]),_:1}),l(c,{label:"原材料出厂检测日期",prop:"leavefactoryDate"},{default:r(()=>[l(Q,{modelValue:o.value.leavefactoryDate,"onUpdate:modelValue":e[18]||(e[18]=t=>o.value.leavefactoryDate=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"原材料入厂检测日期",prop:"detectionTime"},{default:r(()=>[l(Q,{modelValue:o.value.detectionTime,"onUpdate:modelValue":e[19]||(e[19]=t=>o.value.detectionTime=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"质量证明书",prop:"certificate"},{default:r(()=>[l(Ue,{ref_key:"certificateUpload",ref:B,"auto-upload":!1,"on-change":de,limit:3,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png","file-list":[],"show-file-list":!1},{default:r(()=>[l(i,{type:"primary"},{default:r(()=>e[41]||(e[41]=[s("上传质量证明书")])),_:1}),e[42]||(e[42]=b("div",{class:"el-upload__tip"},"支持 pdf、doc、docx、xls、xlsx、jpg、jpeg、png 等格式，最多3个质量证明书",-1))]),_:1},512),o.value.certificate?(v(),y("div",nl,[(v(!0),y(le,null,te(P(o.value.certificate),(t,V)=>(v(),y("div",{key:V,class:"uploaded-file"},[s(F(t.name)+" ",1),l(i,{type:"danger",size:"mini",onClick:Z=>pe(V)},{default:r(()=>e[43]||(e[43]=[s("删除")])),_:2},1032,["onClick"])]))),128))])):Oe("",!0)]),_:1}),l(c,{label:"录入人",prop:"writer"},{default:r(()=>[l(n,{modelValue:o.value.writer,"onUpdate:modelValue":e[20]||(e[20]=t=>o.value.writer=t),disabled:""},null,8,["modelValue"])]),_:1}),l(c,{label:"录入时间",prop:"writeTime"},{default:r(()=>[l(n,{modelValue:o.value.writeTime,"onUpdate:modelValue":e[21]||(e[21]=t=>o.value.writeTime=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),l(ae,{modelValue:_.value,"onUpdate:modelValue":e[23]||(e[23]=t=>_.value=t),onSelect:ke},null,8,["modelValue"]),l(oe,{modelValue:z.value,"onUpdate:modelValue":e[24]||(e[24]=t=>z.value=t),onSelect:Ne},null,8,["modelValue"])]),_:1},8,["title","modelValue"]),l(X,{title:"质量证明书预览",modelValue:U.value,"onUpdate:modelValue":e[29]||(e[29]=t=>U.value=t),width:"80%","close-on-click-modal":!1,"before-close":G},{footer:r(()=>[l(i,{onClick:e[27]||(e[27]=t=>U.value=!1)},{default:r(()=>e[49]||(e[49]=[s("关闭")])),_:1}),l(i,{type:"primary",onClick:e[28]||(e[28]=t=>L(x.value,j.value))},{default:r(()=>e[50]||(e[50]=[s(" 下载 ")])),_:1})]),default:r(()=>[$.value==="image"?(v(),y("div",il,[b("img",{src:x.value,alt:"质量证明书",style:{"max-width":"100%","max-height":"70vh",display:"block",margin:"0 auto"},onError:ue},null,40,ul)])):$.value==="pdf"?(v(),y("div",sl,[b("iframe",{src:x.value,width:"100%",height:"600px",frameborder:"0",onError:se},[e[46]||(e[46]=s(" 您的浏览器不支持PDF预览，请")),b("a",{href:x.value,target:"_blank"},"点击此处下载",8,pl)],40,dl)])):(v(),y("div",ml,[b("div",cl,[l(_e,{size:"64",color:"#909399"},{default:r(()=>[l(Je(Ae))]),_:1}),e[48]||(e[48]=b("p",{style:{margin:"20px 0",color:"#606266"}},"此文件类型不支持在线预览",-1)),l(i,{type:"primary",onClick:e[26]||(e[26]=t=>L(x.value,j.value))},{default:r(()=>e[47]||(e[47]=[s(" 下载文件 ")])),_:1})])]))]),_:1},8,["modelValue"]),l(ae,{modelValue:h.value,"onUpdate:modelValue":e[30]||(e[30]=t=>h.value=t),onSelect:we},null,8,["modelValue"]),l(oe,{modelValue:S.value,"onUpdate:modelValue":e[31]||(e[31]=t=>S.value=t),onSelect:be},null,8,["modelValue"])])}}},Vl=Fe(gl,[["__scopeId","data-v-c50de0cc"]]);export{Vl as default};

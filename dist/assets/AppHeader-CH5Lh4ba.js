import{y as W,f as A,_ as N,r as h,k as T,h as u,o as w,l as U,w as a,a as _,b as s,i as x,c as I,x as P,z as G,E as c,A as K,B as J,s as O,F as M,m as X,p as $,C as Y,q as Z}from"./index-Bwbtb0V1.js";import{u as ee}from"./term-BqpDPAMp.js";import{g as se,u as ae,c as oe}from"./user-mK6w1a3W.js";import{u as re}from"./file-CLvCJErd.js";const le=W("app",{state:()=>({tabsList:[],refreshKeys:{},isCollapse:!1}),getters:{userInfo:()=>{const p=A();return{username:p.username,avatar:p.avatar||"https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png"}}},actions:{addTab(p){var g;this.tabsList.some(m=>m.path===p.path)||(this.tabsList.push({path:p.path,title:p.title||((g=p.meta)==null?void 0:g.title)||"未命名页面"}),this.refreshKeys[p.path]=Date.now())},delTab(p){this.tabsList=this.tabsList.filter(v=>v.path!==p),delete this.refreshKeys[p]},toggleCollapse(){this.isCollapse=!this.isCollapse}}}),te="/erp/assets/logopower-D0nzQ9zP.jpg",ne=["src"],ue={class:"dialog-footer"},de="http://127.0.0.1:8099",ie={__name:"UserProfileDialog",setup(p,{expose:v}){const g=A(),m=h(!1),t=h("profile"),y=h(null),V=h(null),l=h({id:null,username:"",descr:"",phone:"",avatar:""}),i=h({oldPassword:"",newPassword:"",confirmPassword:""}),S={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度在 3 到 20 个字符",trigger:"blur"}],descr:[{required:!0,message:"请输入姓名",trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号",trigger:"blur"}]},f={oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度至少6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(r,e,o)=>{e!==i.value.newPassword?o(new Error("两次输入的密码不一致")):o()},trigger:"blur"}]},n=T(()=>l.value.avatar?de+l.value.avatar:""),C=async()=>{try{const r=g.userId;if(!r){c.error("用户ID不存在");return}console.log("获取用户信息",r);const e=await se({id:r});if(e.success&&e.data&&e.data.user)l.value={id:e.data.user.id,username:e.data.user.username,descr:e.data.user.descr||"",phone:e.data.user.phone||"",avatar:e.data.user.avatar||""},m.value=!0;else throw new Error(e.msg||"获取用户信息失败")}catch(r){c.error(r.message||"获取用户信息失败")}},k=()=>{K.confirm("确定要关闭吗？未保存的更改将丢失","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{m.value=!1,B()}).catch(()=>{})},B=()=>{var r,e;l.value={id:null,username:"",descr:"",phone:"",avatar:""},i.value={oldPassword:"",newPassword:"",confirmPassword:""},(r=y.value)==null||r.resetFields(),(e=V.value)==null||e.resetFields(),t.value="profile"},E=r=>{const e=r.type.startsWith("image/"),o=r.size/1024/1024<2;return e?o?!0:(c.error("图片大小不能超过 2MB!"),!1):(c.error("只能上传图片格式!"),!1)},F=async({file:r})=>{try{const e=new FormData;e.append("file",r);const o=await re(e);if(o.success&&o.data&&o.data.url)l.value.avatar=o.data.url,c.success("头像上传成功");else throw new Error(o.msg||"头像上传失败")}catch(e){c.error(e.message||"头像上传失败")}},D=()=>{t.value==="profile"?y.value.validate(async r=>{if(r)try{const e=await ae(l.value);if(e.success)c.success("用户信息更新成功"),g.setUserInfo({username:l.value.username,avatar:l.value.avatar}),m.value=!1,B();else throw new Error(e.msg||"更新用户信息失败")}catch(e){c.error(e.message||"更新用户信息失败")}}):V.value.validate(async r=>{if(r)try{const e=await oe({userId:String(l.value.id),oldPassword:i.value.oldPassword,newPassword:i.value.newPassword});if(e.success)c.success("密码修改成功"),m.value=!1,g.logout();else throw new Error(e.msg||"密码修改失败")}catch(e){c.error(e.message||"密码修改失败")}})};return v({open:C}),(r,e)=>{const o=u("el-input"),b=u("el-form-item"),H=u("el-icon"),R=u("el-upload"),L=u("el-form"),q=u("el-tab-pane"),j=u("el-tabs"),z=u("el-button"),Q=u("el-dialog");return w(),U(Q,{title:"用户信息",modelValue:m.value,"onUpdate:modelValue":e[7]||(e[7]=d=>m.value=d),width:"500px","before-close":k},{footer:a(()=>[_("span",ue,[s(z,{onClick:k},{default:a(()=>e[8]||(e[8]=[x("取消")])),_:1}),s(z,{type:"primary",onClick:D},{default:a(()=>e[9]||(e[9]=[x("确定")])),_:1})])]),default:a(()=>[s(j,{modelValue:t.value,"onUpdate:modelValue":e[6]||(e[6]=d=>t.value=d),type:"card"},{default:a(()=>[s(q,{label:"基本信息",name:"profile"},{default:a(()=>[s(L,{model:l.value,rules:S,ref_key:"profileForm",ref:y,"label-width":"80px",class:"profile-form"},{default:a(()=>[s(b,{label:"用户名",prop:"username"},{default:a(()=>[s(o,{modelValue:l.value.username,"onUpdate:modelValue":e[0]||(e[0]=d=>l.value.username=d),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),s(b,{label:"姓名",prop:"descr"},{default:a(()=>[s(o,{modelValue:l.value.descr,"onUpdate:modelValue":e[1]||(e[1]=d=>l.value.descr=d),placeholder:"请输入姓名"},null,8,["modelValue"])]),_:1}),s(b,{label:"手机号",prop:"phone"},{default:a(()=>[s(o,{modelValue:l.value.phone,"onUpdate:modelValue":e[2]||(e[2]=d=>l.value.phone=d),placeholder:"请输入手机号"},null,8,["modelValue"])]),_:1}),s(b,{label:"头像",prop:"avatar"},{default:a(()=>[s(R,{class:"avatar-uploader",action:r.uploadAction,"show-file-list":!1,"before-upload":E,"http-request":F},{default:a(()=>[n.value?(w(),I("img",{key:0,src:n.value,class:"avatar"},null,8,ne)):(w(),U(H,{key:1,class:"avatar-uploader-icon"},{default:a(()=>[s(P(G))]),_:1}))]),_:1},8,["action"])]),_:1})]),_:1},8,["model"])]),_:1}),s(q,{label:"修改密码",name:"password"},{default:a(()=>[s(L,{model:i.value,rules:f,ref_key:"passwordForm",ref:V,"label-width":"80px",class:"password-form"},{default:a(()=>[s(b,{label:"旧密码",prop:"oldPassword"},{default:a(()=>[s(o,{modelValue:i.value.oldPassword,"onUpdate:modelValue":e[3]||(e[3]=d=>i.value.oldPassword=d),type:"password",placeholder:"请输入旧密码","show-password":""},null,8,["modelValue"])]),_:1}),s(b,{label:"新密码",prop:"newPassword"},{default:a(()=>[s(o,{modelValue:i.value.newPassword,"onUpdate:modelValue":e[4]||(e[4]=d=>i.value.newPassword=d),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),s(b,{label:"确认密码",prop:"confirmPassword"},{default:a(()=>[s(o,{modelValue:i.value.confirmPassword,"onUpdate:modelValue":e[5]||(e[5]=d=>i.value.confirmPassword=d),type:"password",placeholder:"请确认新密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}},pe=N(ie,[["__scopeId","data-v-394d4856"]]),me={class:"app-header"},ce={class:"term-selector"},fe={class:"header-right"},ve={class:"user-info"},ge={class:"username"},_e={__name:"AppHeader",setup(p){const v=h(null),g=le(),m=A(),t=ee();T(()=>g.isCollapse);const y=T(()=>({username:m.username||"未登录",avatar:J+m.avatar||""})),V=T({get:()=>(console.log("currentTerm getter:",t.currentTerm),t.currentTerm),set:f=>{console.log("currentTerm setter:",f),t.setCurrentTerm(f)}}),l=T(()=>t.terms),i=async f=>{switch(f){case"profile":v.value?v.value.open():(console.error("UserProfileDialog 引用未正确初始化"),c.error("无法打开用户信息弹窗"));break;case"logout":try{await K.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),m.logout(),c.success("已成功退出登录")}catch{console.log("用户取消退出")}break}},S=f=>{console.log("handleTermChange:",f),t.setCurrentTerm(f)};return O(()=>{t.terms.length||t.fetchTerms(),console.log("onMounted: terms",t.terms,"currentTerm",t.currentTerm)}),(f,n)=>{const C=u("el-option"),k=u("el-select"),B=u("el-icon"),E=u("el-tooltip"),F=u("el-avatar"),D=u("el-dropdown-item"),r=u("el-dropdown-menu"),e=u("el-dropdown");return w(),I(M,null,[_("div",me,[n[6]||(n[6]=_("div",{class:"logo-container"},[_("img",{src:te,class:"logo",alt:"企业标识"})],-1)),_("div",ce,[n[3]||(n[3]=x(" 当前期间： ")),s(k,{modelValue:V.value,"onUpdate:modelValue":n[0]||(n[0]=o=>V.value=o),placeholder:"选择当前期间",disabled:P(t).loading||P(t).error,onChange:S,size:"small",style:{width:"150px"}},{default:a(()=>[(w(!0),I(M,null,X(l.value,o=>(w(),U(C,{key:o.id,label:o.term,value:o.term},null,8,["label","value"]))),128)),!l.value.length&&!P(t).loading?(w(),U(C,{key:0,disabled:"",label:"无可用期间",value:""})):$("",!0)]),_:1},8,["modelValue","disabled"]),P(t).error?(w(),U(E,{key:0,content:"期间加载失败，请刷新重试"},{default:a(()=>[s(B,{style:{"margin-left":"8px",color:"#f56c6c"}},{default:a(()=>[s(P(Y))]),_:1})]),_:1})):$("",!0)]),_("div",fe,[s(e,{trigger:"click"},{dropdown:a(()=>[s(r,null,{default:a(()=>[s(D,{onClick:n[1]||(n[1]=o=>i("profile"))},{default:a(()=>n[4]||(n[4]=[x("修改信息")])),_:1}),s(D,{divided:"",onClick:n[2]||(n[2]=o=>i("logout"))},{default:a(()=>n[5]||(n[5]=[x("退出登录")])),_:1})]),_:1})]),default:a(()=>[_("div",ve,[_("span",ge,Z(y.value.username||"未登录"),1),s(F,{size:32,src:y.value.avatar},null,8,["src"])])]),_:1})])]),s(pe,{ref_key:"userProfileDialog",ref:v},null,512)],64)}}},Ve=N(_e,[["__scopeId","data-v-68a4f1bb"]]);export{Ve as A,le as u};

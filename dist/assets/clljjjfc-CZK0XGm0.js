import{O as G,P as He,Q as Ge,R as Ke,_ as Xe,f as Ze,k as el,r as u,g as ll,s as al,h as g,G as tl,o as b,c as w,a as V,b as l,w as r,F as A,m as H,i as p,W as ie,H as ol,l as rl,q as de,p as pe,x as nl,ah as ul,E as f,A as sl,B as il}from"./index-Bwbtb0V1.js";import{a as dl}from"./file-CLvCJErd.js";import{W as me,S as ce,C as pl,I as ml}from"./SupplierDialog-pe6d4KWF.js";import"./plshengchangongdan-BS-Hu3DG.js";import"./basorg-D9Q4sOwh.js";function cl(y){return G("/clljjjfc/getpage",y)}function fl(y){return G("/clljjjfc/get",y)}function vl(y){return He("/clljjjfc/save",y)}function gl(y){return Ge("/clljjjfc/update",y)}function yl(y){return Ke("/clljjjfc/delete",y)}function fe(y){return G("/Basno/getNewNoNyName",{basname:y})}const bl={class:"clljjjfc-management"},wl={class:"action-bar"},Vl=["onClick"],Nl={class:"pagination-container"},Cl={key:0,class:"el-form-item__error"},kl={key:0,class:"uploaded-files"},jl={key:0,class:"preview-container"},Sl=["src"],xl={key:1,class:"preview-container"},Ul=["src"],hl=["href"],Dl={key:2,class:"preview-container"},_l={style:{"text-align":"center",padding:"40px"}},Rl={__name:"clljjjfc",setup(y){const ve=Ze(),K=el(()=>({username:ve.realName||"未登录"})),x=il,ge=["紧固件"],ye={紧固件:"μm"},o=u(Q()),s=ll({maQuality:"",mafactory:"",woNo:"",pageNumber:1,pageSize:10}),F=u([]),X=u(0),O=u(!1),j=u(!1),I=u("新增连接金具辅材"),U=u("add"),$=u(null),P=u(!1),T=u(!1),h=u(!1),z=u(!1),B=u(!1),q=u(!1),D=u(!1),_=u(!1),Y=u(null),Z=()=>{B.value=!0},ee=()=>{q.value=!0},be=a=>{o.value.contractNo=a.contractNo,B.value=!1},we=a=>{o.value.ipoNo=a.ipoNo,q.value=!1},N=u([]),R=u(!1),C=u(""),E=u(""),M=u("");function le(a){if(!a)return[];try{const e=JSON.parse(a);return Array.isArray(e)?e.map(n=>({...n,url:n.url.startsWith("http")?n.url:x+n.url})):[]}catch{return console.warn("Failed to parse certificate JSON for display:",a),[]}}const Ve=a=>{const e=te(a.url,a.name);e==="image"||e==="pdf"?Ne(a.url,a.name,e):J(a.url,a.name)},Ne=(a,e="",n="")=>{const d=a.startsWith("http")?a:x+a;C.value=d,M.value=e,E.value=n||te(d,e),R.value=!0},J=(a,e="")=>{try{const n=a.startsWith("http")?a:x+a,d=document.createElement("a");d.href=n,d.download=e||"质量证明书",d.target="_blank",document.body.appendChild(d),d.click(),document.body.removeChild(d),f.success("文件下载已开始")}catch(n){console.error("下载文件失败:",n),f.error("文件下载失败，请稍后重试"),window.open(a.startsWith("http")?a:x+a,"_blank")}},ae=()=>{R.value=!1,C.value="",M.value="",E.value=""},Ce=()=>{f.error("图片加载失败")},ke=()=>{f.error("PDF预览失败，请尝试下载文件")},te=(a,e="")=>{const n=a||e;return/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?"image":/\.pdf$/i.test(n)?"pdf":"other"},je=async a=>{if(N.value.length>=3){f.warning("最多只能上传3个质量证明书"),Y.value.clearFiles();return}const e=new FormData;e.append("file",a.raw);try{const n=await dl(e);if(n.success&&n.data&&n.data.url){const d=x+n.data.url,i=JSON.parse(o.value.certificate||"[]");i.push({name:a.name,url:d}),o.value.certificate=JSON.stringify(i),N.value.push({name:a.name,url:d}),f.success(`${a.name} 上传成功`)}else throw new Error(n.msg||"文件上传失败")}catch(n){console.error("文件上传失败",n),f.error(`${a.name} 上传失败`),Y.value.clearFiles()}},Se=a=>{const e=JSON.parse(o.value.certificate||"[]");e.splice(a,1),o.value.certificate=JSON.stringify(e),N.value.splice(a,1)};function xe(a){if(!a)return"";const e=a.match(/(-?\d+(\.\d+)?)/);if(e){const n=Math.round(Number(e[1]));return a.replace(/(-?\d+(\.\d+)?)/,n)}return a}const Ue=()=>{if(o.value.testResult){const a=o.value.testResult,e=xe(a),n=a.match(/(-?\d+(\.\d+)?)/),d=e.match(/(-?\d+)/);n&&d&&n[0]!==d[0]&&n[2]?T.value=!0:T.value=!1,o.value.testResult=e}};function Q(){return{id:void 0,maQuality:"",matRecheckNo:"",mafactory:"",orderno:"",sampleNumber:"",testResult:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",contractNo:"",woNo:"",ipoNo:"",writer:"",writeTime:"",basno:"",flag:"",status:"",memo:"",type:""}}const he={maQuality:[{required:!0,message:"请选择辅材类型",trigger:"change"}],matRecheckNo:[{required:!0,message:"请填写来料检验批次号",trigger:"blur"}],mafactory:[{required:!0,message:"请选择原材料制造商",trigger:"change"}],orderno:[{required:!0,message:"请填写入库单号",trigger:"blur"}],sampleNumber:[{required:!0,message:"请填写样品编号",trigger:"blur"}],testResult:[{required:!0,message:"请填写检测结果",trigger:"blur"}],leavefactoryDate:[{required:!0,message:"请选择原材料出厂检测日期",trigger:"change"}],detectionTime:[{required:!0,message:"请选择原材料入厂检测日期",trigger:"change"}],certificate:[{required:!0,message:"请上传质量证明书",trigger:"change"}],woNo:[{max:50,message:"请选择生产工单号",trigger:"change"}],contractNo:[{required:!0,message:"合同编号不能为空",trigger:"change"}],ipoNo:[{max:50,message:"生产订单号不能为空",trigger:"change"}],writer:[{required:!0,message:"录入人不能为空",trigger:"blur"}],basno:[{max:50,message:"请获取单据号",trigger:"blur"}]},S=async()=>{O.value=!0;try{const a=await cl(s);F.value=a.data.page.list,X.value=a.data.page.totalRow,F.value.length>0?console.log("第一条数据的单据号:",F.value[0].basno):console.log("列表为空")}catch{f.error("获取数据失败")}finally{O.value=!1}},W=()=>{s.maQuality="",s.mafactory="",s.woNo="",s.pageNumber=1,S()},De=a=>{s.pageSize=a,S()},_e=a=>{s.pageNumber=a,S()},Re=async()=>{if(I.value="新增连接金具辅材",U.value="add",o.value=Q(),o.value.writer=K.value.username,o.value.writeTime=re(new Date),L.value)o.value.basno=L.value,L.value="";else try{const a=await fe("clljjjfc");a.code===200?o.value.basno=a.data.fullNoNyName:f.warning("获取单据号失败，可手动填写")}catch(a){console.error("获取单据号异常",a),f.error("获取单据号失败")}N.value=[],o.value.certificate="[]",j.value=!0},Fe=async a=>{I.value="编辑连接金具辅材",U.value="edit";try{const e=await fl({id:a.id});e&&e.code===200&&e.data&&e.data.clLjjjFc&&(o.value={...Q(),...e.data.clLjjjFc}),N.value=le(o.value.certificate),j.value=!0}catch(e){console.error("获取详情失败",e)}},$e=a=>{sl.confirm("确认删除该条辅材数据吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{await yl({id:a.id}),f.success("删除成功"),W()}).catch(()=>{})},Te=a=>{(U.value==="add"||U.value==="edit")&&(o.value.testResult=ye[a]||"")},oe=()=>{z.value=!0},ze=a=>{s.mafactory=a,h.value=!1},Be=a=>{s.woNo=a.woNo,_.value=!1},qe=()=>{s.mafactory=""},Ee=()=>{s.woNo=""},Me=a=>{o.value.mafactory=a,D.value=!1},Qe=async a=>{o.value.woNo=a.woNo,z.value=!1},We=()=>{$.value.validate(async a=>{if(a){P.value=!0;try{if(o.value.certificate=JSON.stringify(N.value),!o.value.basno){f.error("单据号未生成，请刷新重试");return}if(U.value==="add"){o.value.writer=K.value.username,o.value.writeTime=re(new Date),await vl(o.value),f.success("新增成功");try{const e=await fe("clljjjfc");e.code===200&&(L.value=e.data.fullNoNyName)}catch(e){console.error("获取新单据号异常",e)}W()}else await gl(o.value),f.success("修改成功"),W();j.value=!1}catch(e){console.error("保存失败:",e),f.error("保存失败: "+(e.message||e))}finally{P.value=!1}}})},L=u("");function re(a){if(!a)return"";const e=new Date(a),n=d=>d.toString().padStart(2,"0");return`${e.getFullYear()}-${n(e.getMonth()+1)}-${n(e.getDate())} ${n(e.getHours())}:${n(e.getMinutes())}:${n(e.getSeconds())}`}const Le=()=>{o.value=Q(),N.value=[],ae(),$.value&&$.value.resetFields(),T.value=!1};return al(S),(a,e)=>{const n=g("el-option"),d=g("el-select"),i=g("el-button"),v=g("el-input"),m=g("el-table-column"),Oe=g("el-table"),Ie=g("el-pagination"),c=g("el-form-item"),ne=g("el-date-picker"),Pe=g("el-upload"),Ye=g("el-form"),ue=g("el-dialog"),Je=g("el-icon"),Ae=tl("loading");return b(),w("div",bl,[V("div",wl,[l(d,{modelValue:s.maQuality,"onUpdate:modelValue":e[0]||(e[0]=t=>s.maQuality=t),placeholder:"辅材类型",style:{width:"140px","margin-right":"10px"},clearable:"",onChange:S},{default:r(()=>[(b(),w(A,null,H(ge,t=>l(n,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),l(v,{modelValue:s.mafactory,"onUpdate:modelValue":e[2]||(e[2]=t=>s.mafactory=t),placeholder:"原材料制造商",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[3]||(e[3]=ie(t=>h.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:qe},{append:r(()=>[l(i,{onClick:e[1]||(e[1]=t=>h.value=!0),size:"small"},{default:r(()=>e[37]||(e[37]=[p("选择")])),_:1})]),_:1},8,["modelValue"]),l(v,{modelValue:s.woNo,"onUpdate:modelValue":e[5]||(e[5]=t=>s.woNo=t),placeholder:"生产工单号",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[6]||(e[6]=ie(t=>_.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:Ee},{append:r(()=>[l(i,{onClick:e[4]||(e[4]=t=>_.value=!0),size:"small"},{default:r(()=>e[38]||(e[38]=[p("选择")])),_:1})]),_:1},8,["modelValue"]),l(i,{type:"primary",onClick:S},{default:r(()=>e[39]||(e[39]=[p("搜索")])),_:1}),l(i,{type:"warning",onClick:W,style:{"margin-left":"10px"}},{default:r(()=>e[40]||(e[40]=[p("重置")])),_:1}),l(i,{type:"primary",style:{"margin-left":"auto"},onClick:Re},{default:r(()=>e[41]||(e[41]=[p("新增连接金具辅材")])),_:1})]),ol((b(),rl(Oe,{data:F.value,border:"",style:{width:"100%"}},{default:r(()=>[l(m,{type:"index",label:"序号",width:"70"}),l(m,{prop:"basno",label:"单据号"}),l(m,{prop:"maQuality",label:"辅材类型"}),l(m,{prop:"matRecheckNo",label:"来料检验批次号"}),l(m,{prop:"mafactory",label:"原材料制造商"}),l(m,{prop:"orderno",label:"入库单号"}),l(m,{prop:"sampleNumber",label:"样品编号"}),l(m,{prop:"testResult",label:"检测结果"}),l(m,{prop:"leavefactoryDate",label:"原材料出厂检测日期",width:"130"}),l(m,{prop:"detectionTime",label:"原材料入厂检测日期",width:"130"}),l(m,{label:"质量证明书"},{default:r(({row:t})=>[(b(!0),w(A,null,H(le(t.certificate),(k,se)=>(b(),w("div",{key:se},[V("span",{class:"file-link",onClick:Fl=>Ve(k)},de(k.name),9,Vl)]))),128))]),_:1}),l(m,{prop:"contractNo",label:"合同编号"}),l(m,{prop:"woNo",label:"生产工单号"}),l(m,{prop:"ipoNo",label:"生产订单号"}),l(m,{prop:"writer",label:"录入人"}),l(m,{prop:"writeTime",label:"录入时间",width:"150"}),l(m,{label:"操作",width:"220",fixed:"right"},{default:r(({row:t})=>[l(i,{type:"primary",size:"small",onClick:k=>Fe(t)},{default:r(()=>e[42]||(e[42]=[p("编辑")])),_:2},1032,["onClick"]),l(i,{type:"danger",size:"small",onClick:k=>$e(t)},{default:r(()=>e[43]||(e[43]=[p("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ae,O.value]]),V("div",Nl,[l(Ie,{"current-page":s.pageNumber,"onUpdate:currentPage":e[7]||(e[7]=t=>s.pageNumber=t),"page-size":s.pageSize,"onUpdate:pageSize":e[8]||(e[8]=t=>s.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:X.value,onSizeChange:De,onCurrentChange:_e},null,8,["current-page","page-size","total"])]),l(ue,{title:I.value,modelValue:j.value,"onUpdate:modelValue":e[28]||(e[28]=t=>j.value=t),width:"700px",onClosed:Le},{footer:r(()=>[l(i,{onClick:e[25]||(e[25]=t=>j.value=!1)},{default:r(()=>e[52]||(e[52]=[p("取消")])),_:1}),l(i,{type:"primary",onClick:We,loading:P.value},{default:r(()=>e[53]||(e[53]=[p("保存")])),_:1},8,["loading"])]),default:r(()=>[l(Ye,{ref_key:"formRef",ref:$,model:o.value,rules:he,"label-width":"120px"},{default:r(()=>[l(c,{label:"生产工单号",prop:"woNo"},{default:r(()=>[l(v,{modelValue:o.value.woNo,"onUpdate:modelValue":e[9]||(e[9]=t=>o.value.woNo=t),placeholder:"请选择生产工单号",readonly:"",style:{width:"calc(100% - 80px)"},onClick:oe},{append:r(()=>[l(i,{onClick:oe,size:"small"},{default:r(()=>e[44]||(e[44]=[p("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"合同编号",prop:"contractNo"},{default:r(()=>[l(v,{modelValue:o.value.contractNo,"onUpdate:modelValue":e[10]||(e[10]=t=>o.value.contractNo=t),placeholder:"请选择合同编号",readonly:"",onClick:Z},{append:r(()=>[l(i,{onClick:Z,size:"small"},{default:r(()=>e[45]||(e[45]=[p("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"生产订单号",prop:"ipoNo"},{default:r(()=>[l(v,{modelValue:o.value.ipoNo,"onUpdate:modelValue":e[11]||(e[11]=t=>o.value.ipoNo=t),placeholder:"请选择生产订单号",readonly:"",onClick:ee},{append:r(()=>[l(i,{onClick:ee,size:"small"},{default:r(()=>e[46]||(e[46]=[p("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"单据号",prop:"basno"},{default:r(()=>[l(v,{modelValue:o.value.basno,"onUpdate:modelValue":e[12]||(e[12]=t=>o.value.basno=t),placeholder:"自动生成",readonly:""},null,8,["modelValue"])]),_:1}),l(c,{label:"辅材类型",prop:"maQuality"},{default:r(()=>[l(d,{modelValue:o.value.maQuality,"onUpdate:modelValue":e[13]||(e[13]=t=>o.value.maQuality=t),placeholder:"请选择辅材类型",style:{width:"100%"},onChange:Te},{default:r(()=>[l(n,{label:"紧固件",value:"紧固件"})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"来料检验批次号",prop:"matRecheckNo"},{default:r(()=>[l(v,{modelValue:o.value.matRecheckNo,"onUpdate:modelValue":e[14]||(e[14]=t=>o.value.matRecheckNo=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(c,{label:"原材料制造商",prop:"mafactory"},{default:r(()=>[l(v,{modelValue:o.value.mafactory,"onUpdate:modelValue":e[16]||(e[16]=t=>o.value.mafactory=t),placeholder:"请选择原材料制造商",readonly:"",style:{cursor:"pointer"},onClick:e[17]||(e[17]=t=>D.value=!0)},{append:r(()=>[l(i,{onClick:e[15]||(e[15]=t=>D.value=!0),size:"small"},{default:r(()=>e[47]||(e[47]=[p("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"入库单号",prop:"orderno"},{default:r(()=>[l(v,{modelValue:o.value.orderno,"onUpdate:modelValue":e[18]||(e[18]=t=>o.value.orderno=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(c,{label:"样品编号",prop:"sampleNumber"},{default:r(()=>[l(v,{modelValue:o.value.sampleNumber,"onUpdate:modelValue":e[19]||(e[19]=t=>o.value.sampleNumber=t),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(c,{label:"检测结果",prop:"testResult"},{default:r(()=>[l(v,{modelValue:o.value.testResult,"onUpdate:modelValue":e[20]||(e[20]=t=>o.value.testResult=t),maxlength:"100",type:"textarea",rows:2,placeholder:"请输入检测结果",onBlur:Ue},null,8,["modelValue"]),e[48]||(e[48]=V("div",{class:"el-form-item__tip"},"提示：数值部分将自动四舍五入为整数 (单位: μm)",-1)),T.value?(b(),w("div",Cl,"检测结果中的数值应保留0位小数，已自动四舍五入")):pe("",!0)]),_:1}),l(c,{label:"原材料出厂检测日期",prop:"leavefactoryDate"},{default:r(()=>[l(ne,{modelValue:o.value.leavefactoryDate,"onUpdate:modelValue":e[21]||(e[21]=t=>o.value.leavefactoryDate=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"原材料入厂检测日期",prop:"detectionTime"},{default:r(()=>[l(ne,{modelValue:o.value.detectionTime,"onUpdate:modelValue":e[22]||(e[22]=t=>o.value.detectionTime=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"质量证明书",prop:"certificate"},{default:r(()=>[l(Pe,{ref_key:"certificateUpload",ref:Y,"auto-upload":!1,"on-change":je,limit:3,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png","file-list":[],"show-file-list":!1},{default:r(()=>[l(i,{type:"primary"},{default:r(()=>e[49]||(e[49]=[p("上传质量证明书")])),_:1}),e[50]||(e[50]=V("div",{class:"el-upload__tip"},"支持 pdf、doc、docx、xls、xlsx、jpg、jpeg、png 等格式，最多3个质量证明书",-1))]),_:1},512),o.value.certificate?(b(),w("div",kl,[(b(!0),w(A,null,H(JSON.parse(o.value.certificate),(t,k)=>(b(),w("div",{key:k,class:"uploaded-file"},[p(de(t.name)+" ",1),l(i,{type:"danger",size:"mini",onClick:se=>Se(k)},{default:r(()=>e[51]||(e[51]=[p("删除")])),_:2},1032,["onClick"])]))),128))])):pe("",!0)]),_:1}),l(c,{label:"录入人",prop:"writer"},{default:r(()=>[l(v,{modelValue:o.value.writer,"onUpdate:modelValue":e[23]||(e[23]=t=>o.value.writer=t),disabled:""},null,8,["modelValue"])]),_:1}),l(c,{label:"录入时间",prop:"writeTime"},{default:r(()=>[l(v,{modelValue:o.value.writeTime,"onUpdate:modelValue":e[24]||(e[24]=t=>o.value.writeTime=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),l(me,{modelValue:z.value,"onUpdate:modelValue":e[26]||(e[26]=t=>z.value=t),onSelect:Qe},null,8,["modelValue"]),l(ce,{modelValue:D.value,"onUpdate:modelValue":e[27]||(e[27]=t=>D.value=t),onSelect:Me},null,8,["modelValue"])]),_:1},8,["title","modelValue"]),l(ue,{title:"质量证明书预览",modelValue:R.value,"onUpdate:modelValue":e[32]||(e[32]=t=>R.value=t),width:"80%","close-on-click-modal":!1,"before-close":ae},{footer:r(()=>[l(i,{onClick:e[30]||(e[30]=t=>R.value=!1)},{default:r(()=>e[57]||(e[57]=[p("关闭")])),_:1}),l(i,{type:"primary",onClick:e[31]||(e[31]=t=>J(C.value,M.value))},{default:r(()=>e[58]||(e[58]=[p(" 下载 ")])),_:1})]),default:r(()=>[E.value==="image"?(b(),w("div",jl,[V("img",{src:C.value,alt:"质量证明书",style:{"max-width":"100%","max-height":"70vh",display:"block",margin:"0 auto"},onError:Ce},null,40,Sl)])):E.value==="pdf"?(b(),w("div",xl,[V("iframe",{src:C.value,width:"100%",height:"600px",frameborder:"0",onError:ke},[e[54]||(e[54]=p(" 您的浏览器不支持PDF预览，请")),V("a",{href:C.value,target:"_blank"},"点击此处下载",8,hl)],40,Ul)])):(b(),w("div",Dl,[V("div",_l,[l(Je,{size:"64",color:"#909399"},{default:r(()=>[l(nl(ul))]),_:1}),e[56]||(e[56]=V("p",{style:{margin:"20px 0",color:"#606266"}},"此文件类型不支持在线预览",-1)),l(i,{type:"primary",onClick:e[29]||(e[29]=t=>J(C.value,M.value))},{default:r(()=>e[55]||(e[55]=[p(" 下载文件 ")])),_:1})])]))]),_:1},8,["modelValue"]),l(me,{modelValue:_.value,"onUpdate:modelValue":e[33]||(e[33]=t=>_.value=t),onSelect:Be},null,8,["modelValue"]),l(pl,{modelValue:B.value,"onUpdate:modelValue":e[34]||(e[34]=t=>B.value=t),onSelect:be},null,8,["modelValue"]),l(ml,{modelValue:q.value,"onUpdate:modelValue":e[35]||(e[35]=t=>q.value=t),onSelect:we},null,8,["modelValue"]),l(ce,{modelValue:h.value,"onUpdate:modelValue":e[36]||(e[36]=t=>h.value=t),onSelect:ze},null,8,["modelValue"])])}}},El=Xe(Rl,[["__scopeId","data-v-a7ee4fc4"]]);export{El as default};

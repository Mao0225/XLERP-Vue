import{f as O}from"./plpaichanjihua-Dut_nnxx.js";import{_ as F,r as y,v as C,h as x,o as w,l as L,w as a,a as d,b as n,i as c,q as s,Y as V,E as I,af as R,k as M,c as $,F as G,m as J,p as Y,B as H}from"./index-Bwbtb0V1.js";const K={class:"beiliaodan-container"},Q={__name:"chakanbeiliaodan",props:{visible:{type:Boolean,default:!1},contractno:{type:String,required:!0},gdItemId:{type:[String,Number],required:!0}},emits:["update:visible","update:gdItemId","cancel"],setup(h,{emit:S}){const m=h,z=S,r=y([]),f=y([]),U=y(null),j={productUnit:"unit",materialUnit:"sxclunit"},b=l=>!l||!Array.isArray(l)?(console.warn("API数据格式不正确:",l),[]):l.map(o=>{const e={};return Object.entries(o).forEach(([i,u])=>{u==null?["sxclshijishuliang","sxclshuliang","sxcltihuoshuliang","dinghuotaoshu"].includes(i)?e[i]=0:e[i]="":e[i]=u}),Object.entries(j).forEach(([i,u])=>{e[u]!==void 0&&(e[i]=e[u])}),e.productUnit=e.unit||"套",e.materialUnit=e.sxclunit||e.sxcldanwei||e.unit||"套",e.sxclname=e.sxclname||e.sxclitemname||"",["sxclshijishuliang","sxclshuliang","sxcltihuoshuliang","dinghuotaoshu"].forEach(i=>{const u=e[i];typeof u=="string"&&u!==""&&(e[i]=Number(u)||0)}),e}),_=l=>{if(!l)return"";if(typeof l=="number")return new Date(l).toLocaleDateString();if(typeof l=="string"){const o=new Date(l);return isNaN(o.getTime())?l:o.toLocaleDateString()}return l},g=l=>{console.log("更新 visible:",l),z("update:visible",l)},D=({row:l,column:o,rowIndex:e,columnIndex:i})=>{if(i<7){const u=f.value[e];return u===0?{rowspan:0,colspan:1}:{rowspan:u,colspan:1}}return{rowspan:1,colspan:1}},k=()=>{if(console.log("计算行合并规则, 数据长度:",r.value.length),f.value=[],!r.value||r.value.length===0)return;r.value.forEach(()=>{f.value.push(1)});let l=0;for(;l<r.value.length;){let o=1;const e=r.value[l];for(let i=l+1;i<r.value.length;i++){const u=r.value[i];if(String(e.itemno||"")===String(u.itemno||"")&&String(e.spec||"")===String(u.spec||"")&&String(e.name||"")===String(u.name||"")&&String(e.productUnit||"")===String(u.productUnit||"")&&String(e.dinghuotaoshu||"")===String(u.dinghuotaoshu||"")&&String(e.noticedrawno||"")===String(u.noticedrawno||""))o++,f.value[i]=0;else break}f.value[l]=o,console.log(`行 ${l} 设置合并行数: ${o}, 组内包含行: ${l} 到 ${l+o-1}`),l+=o}console.log("最终合并规则 spanArr:",f.value),console.log("合并后预览:"),f.value.forEach((o,e)=>{var i,u,t,p;o>0?console.log(`  第${e}行: 合并${o}行 - ${(i=r.value[e])==null?void 0:i.itemno} ${(u=r.value[e])==null?void 0:u.spec}`):console.log(`  第${e}行: 被合并 - ${(t=r.value[e])==null?void 0:t.itemno} ${(p=r.value[e])==null?void 0:p.spec}`)})},N=()=>{z("update:gdItemId",""),z("cancel")},v=l=>{const o=[];return l.forEach((e,i)=>{["itemno","spec","name","sxclitemno","sxclname"].forEach(p=>{e[p]||o.push(`第${i+1}行缺少字段: ${p}`)}),["dinghuotaoshu","sxclshuliang","sxcltihuoshuliang","sxclshijishuliang"].forEach(p=>{e[p]!==void 0&&isNaN(Number(e[p]))&&o.push(`第${i+1}行字段${p}不是有效数字: ${e[p]}`)})}),o.length>0&&(console.warn("数据验证发现问题:",o),I.warning(`数据验证发现 ${o.length} 个问题，请检查控制台`)),o},E=async()=>{if(!m.gdItemId){console.log("无效的 gdItemId:",m.gdItemId),I.error("无效的工单ID");return}let l=null;try{l=R.service({lock:!0,text:"加载数据中...",background:"rgba(0, 0, 0, 0.7)"}),console.log("开始加载备料计划数据，gdItemId:",m.gdItemId);const o=await O(m.gdItemId);if(U.value=o,console.log("API响应:",o),o.success){const e=o.data.List||[];if(console.log("原始数据条数:",e.length),e.length===0){I.warning("未获取到备料计划数据"),r.value=[];return}const i=b(e);console.log("处理后数据条数:",i.length),v(i),i.sort((u,t)=>{const p=["itemno","spec","name","productUnit","noticedrawno"];for(const A of p){const B=String(u[A]||""),q=String(t[A]||"");if(B!==q)return B.localeCompare(q)}const P=Number(u.dinghuotaoshu)||0,T=Number(t.dinghuotaoshu)||0;return P-T}),r.value=i,console.log("最终表格数据:",r.value),k(),I.success(`成功加载 ${r.value.length} 条备料计划数据`)}else console.error("API请求失败:",o.msg),I.error(o.msg||"获取备料计划失败"),r.value=[]}catch(o){console.error("获取备料计划失败:",o),I.error("获取备料计划失败: "+o.message),r.value=[]}finally{l==null||l.close()}};return C(()=>m.visible,l=>{console.log("visible 变化:",l),l&&E()}),C(r,l=>{console.log("beiliaoList 数据更新，条数:",l.length)},{deep:!0}),(l,o)=>{const e=x("el-table-column"),i=x("el-table"),u=x("el-dialog");return w(),L(u,{title:"查看备料计划","model-value":h.visible,width:"80%",onClosed:N,"onUpdate:modelValue":g},{default:a(()=>[d("div",K,[n(i,{data:r.value,border:"",size:"small",style:{width:"100%"},"span-method":D,class:"beiliao-table"},{default:a(()=>[n(e,{prop:"itemno",label:"订货产品编码",width:"120"},{default:a(({row:t})=>[c(s(t.itemno||"-"),1)]),_:1}),n(e,{prop:"spec",label:"订货产品型号",width:"120"},{default:a(({row:t})=>[c(s(t.spec||"-"),1)]),_:1}),n(e,{prop:"name",label:"订货产品名称","min-width":"150"},{default:a(({row:t})=>[c(s(t.name||"-"),1)]),_:1}),n(e,{prop:"productUnit",label:"订货产品单位",width:"80"},{default:a(({row:t})=>[c(s(t.productUnit||"-"),1)]),_:1}),n(e,{prop:"dinghuotaoshu",label:"合同订货套数",width:"80"},{default:a(({row:t})=>[c(s(t.dinghuotaoshu||0),1)]),_:1}),n(e,{prop:"dinghuotaoshupaichan",label:"排产计划生产套数",width:"80"},{default:a(({row:t})=>[c(s(t.dinghuotaoshupaichan||0),1)]),_:1}),n(e,{prop:"noticedrawno",label:"图纸编号",width:"120"},{default:a(({row:t})=>[c(s(t.noticedrawno||"-"),1)]),_:1}),n(e,{prop:"sxclitemno",label:"子材料编码",width:"120"},{default:a(({row:t})=>[c(s(t.sxclitemno||"-"),1)]),_:1}),n(e,{prop:"sxclname",label:"子材料名称","min-width":"150"},{default:a(({row:t})=>[c(s(t.sxclname||"-"),1)]),_:1}),n(e,{prop:"materialUnit",label:"材料单位",width:"80"},{default:a(({row:t})=>[c(s(t.materialUnit||"-"),1)]),_:1}),n(e,{prop:"sxclshuliang",label:"所需材料数量",width:"100"},{default:a(({row:t})=>[d("span",{class:V({"text-red":t.sxclshuliang===0})},s(t.sxclshuliang),3)]),_:1}),n(e,{prop:"sxcltihuoshuliang",label:"子材料数量",width:"100"},{default:a(({row:t})=>[d("span",{class:V({"text-red":t.sxcltihuoshuliang===0})},s(t.sxcltihuoshuliang),3)]),_:1}),n(e,{prop:"sxclshijishuliang",label:"实际备货数量",width:"100"},{default:a(({row:t})=>[d("span",{class:V({"text-red":t.sxclshijishuliang===0})},s(t.sxclshijishuliang),3)]),_:1}),n(e,{prop:"sxclcaizhi",label:"材质",width:"100"},{default:a(({row:t})=>[c(s(t.sxclcaizhi||"-"),1)]),_:1}),n(e,{prop:"zhidingbumen",label:"制定部门",width:"100"},{default:a(({row:t})=>[c(s(t.zhidingbumen||"-"),1)]),_:1}),n(e,{prop:"zhidingriqi",label:"制定日期",width:"100"},{default:a(({row:t})=>[c(s(_(t.zhidingriqi)||"-"),1)]),_:1}),n(e,{prop:"tiliaoshijian",label:"提料时间",width:"100"},{default:a(({row:t})=>[c(s(_(t.tiliaoshijian)||"-"),1)]),_:1}),n(e,{prop:"jiaohuoshijian",label:"交货时间",width:"100"},{default:a(({row:t})=>[c(s(_(t.jiaohuoshijian)||"-"),1)]),_:1}),n(e,{prop:"memo",label:"备注","min-width":"120"},{default:a(({row:t})=>[c(s(t.memo||"-"),1)]),_:1}),n(e,{prop:"bianzhiren",label:"编制人",width:"80"},{default:a(({row:t})=>[c(s(t.bianzhiren||"-"),1)]),_:1}),n(e,{prop:"jiaoyanren",label:"校验人",width:"80"},{default:a(({row:t})=>[c(s(t.jiaoyanren||"-"),1)]),_:1}),n(e,{prop:"shenheren",label:"审核人",width:"80"},{default:a(({row:t})=>[c(s(t.shenheren||"-"),1)]),_:1})]),_:1},8,["data"])])]),_:1},8,["model-value"])}}},pe=F(Q,[["__scopeId","data-v-941eadb8"]]),W={class:"form-row"},X={class:"value-text highlight"},Z={class:"value-text"},ee={class:"value-text"},te={class:"form-row"},le={class:"value-text"},ae={class:"value-text"},oe={class:"form-row"},ne={class:"value-text"},se={class:"value-text"},ie={key:0,class:"file-list"},ue=["href","download"],re={key:1,class:"no-file"},ce={__name:"TuzhiInfoDialog",props:{visible:{type:Boolean,default:!1},tuzhiInfo:{type:Object,default:()=>({})}},emits:["update:visible"],setup(h,{emit:S}){const m=h,z=S,r=y(m.visible);C(()=>m.visible,b=>{r.value=b});const f=M(()=>{if(!m.tuzhiInfo.tuzhiurl)return[];try{return JSON.parse(m.tuzhiInfo.tuzhiurl)}catch(b){return console.error("解析图纸URL失败:",b),[]}}),U=b=>H+b,j=()=>{r.value=!1,z("update:visible",!1)};return(b,_)=>{const g=x("el-form-item"),D=x("el-form"),k=x("el-button"),N=x("el-dialog");return w(),L(N,{modelValue:r.value,"onUpdate:modelValue":_[0]||(_[0]=v=>r.value=v),title:"图纸信息预览",width:"700px","close-on-click-modal":!1,onClose:j},{footer:a(()=>[n(k,{onClick:j},{default:a(()=>_[1]||(_[1]=[c("关闭")])),_:1})]),default:a(()=>[h.tuzhiInfo?(w(),L(D,{key:0,"label-width":"100px",model:h.tuzhiInfo,class:"compact-form"},{default:a(()=>[d("div",W,[n(g,{label:"图纸名称"},{default:a(()=>[d("span",X,s(h.tuzhiInfo.tuzhimingcheng),1)]),_:1}),n(g,{label:"图纸编号"},{default:a(()=>[d("span",Z,s(h.tuzhiInfo.tuzhibianhao),1)]),_:1})]),n(g,{label:"图纸描述"},{default:a(()=>[d("span",ee,s(h.tuzhiInfo.tuzhimiaoshu||"-"),1)]),_:1}),d("div",te,[n(g,{label:"图纸作者"},{default:a(()=>[d("span",le,s(h.tuzhiInfo.tuzhizuozhe),1)]),_:1}),n(g,{label:"创建日期"},{default:a(()=>[d("span",ae,s(h.tuzhiInfo.chuangzuoriqi),1)]),_:1})]),d("div",oe,[n(g,{label:"录入人"},{default:a(()=>[d("span",ne,s(h.tuzhiInfo.writer),1)]),_:1}),n(g,{label:"备注"},{default:a(()=>[d("span",se,s(h.tuzhiInfo.memo||"-"),1)]),_:1})]),n(g,{label:"图纸文件",class:"file-item"},{default:a(()=>[f.value.length>0?(w(),$("div",ie,[(w(!0),$(G,null,J(f.value,(v,E)=>(w(),$("a",{key:E,href:U(v.url),download:v.name,target:"_blank",class:"file-link"}," 📄 "+s(v.name),9,ue))),128))])):(w(),$("span",re,"暂无文件"))]),_:1})]),_:1},8,["model"])):Y("",!0)]),_:1},8,["modelValue"])}}},me=F(ce,[["__scopeId","data-v-c68353b4"]]);export{me as T,pe as c};

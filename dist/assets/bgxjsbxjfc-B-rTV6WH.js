import{O as W,P as Be,Q as De,R as Me,_ as $e,f as We,g as J,r as p,k as Le,s as Oe,h as f,G as Qe,o as w,c as k,a as j,b as t,e as _,w as r,i as g,x as Y,a6 as qe,H as ie,l as ue,F as de,m as pe,ai as ce,q as Je,p as Ye,E as b,A as Ee,B as Ke}from"./index-Bwbtb0V1.js";import{a as Ie}from"./file-CLvCJErd.js";import{W as Pe}from"./WoNoSelector-Bg7qus67.js";import{g as Ae}from"./basorg-D9Q4sOwh.js";import"./plshengchangongdan-BS-Hu3DG.js";function He(m){return W("/clbgxjsbxjFc/getpage",m)}function Ge(m){return W("/clbgxjsbxjFc/get",m)}function Xe(m){return Be("/clbgxjsbxjFc/save",m)}function Ze(m){return De("/clbgxjsbxjFc/update",m)}function et(m){return Me("/clbgxjsbxjFc/delete",m)}function tt(m){return W("/clbgxjsbxjFc/getWoNoList",m)}function me(m){return W("/Basno/getNewNoNyName",{basname:m})}const at={class:"bgxjsbxjFc-management"},lt={class:"action-bar"},ot=["onClick"],rt={class:"pagination-container"},nt={key:0,class:"uploaded-files"},st=["onClick"],it={class:"pagination-container"},ut={__name:"bgxjsbxjfc",setup(m){const ge=Ke,z=We(),E=()=>(console.log("获取登录用户名称",z.descr),z.descr),i=J({mafactory:"",maQuality:"",orderno:"",matRecheckNo:"",pageNumber:1,pageSize:10}),K=p([]),I=p(0),L=p(!1),V=p(!1),P=p([]),A=p(0),O=p(!1),U=p(!1),H=p([]),G=p(0),Q=p(!1),y=J({descr:"",type:1,pageNumber:1,pageSize:10}),x=p(!1),h=p("add"),fe=Le(()=>h.value==="add"?"新增数据":"编辑数据"),C=p(null),F=p(null),R=p([]),l=J({id:void 0,contractNo:"",woNo:"",ipoNo:"",mafactory:"",maQuality:"",orderno:"",matRecheckNo:"",testType:"",testResult:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",writeTime:"",writer:E(),status:0,isdelete:0,basno:""}),be={mafactory:[{required:!0,message:"请选择原材料制造商",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],maQuality:[{required:!0,message:"请输入材质",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],orderno:[{required:!0,message:"请输入入库单号",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],matRecheckNo:[{required:!0,message:"请输入来料检测批测号",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],testType:[{required:!0,message:"请输入试验类型",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],testResult:[{required:!0,message:"请输入检测结果",trigger:"blur"}],leavefactoryDate:[{required:!0,message:"请输入出厂日期",trigger:"change"}],detectionTime:[{required:!0,message:"请输入入厂日期",trigger:"change"}],contractNo:[{required:!0,message:"长度不能超过50个字符",trigger:"blur"}],woNo:[{max:50,message:"长度不能超过50个字符",trigger:"blur"}],ipoNo:[{max:50,message:"长度不能超过50个字符",trigger:"blur"}],basno:[{max:50,message:"请获取单据号",trigger:"blur"}]},X=()=>{U.value=!0,S()},S=async()=>{Q.value=!0;try{const o=await Ae(y);H.value=o.data.page.list,G.value=o.data.page.totalRow}catch(o){console.error("获取供应商列表失败",o),b.error("获取供应商列表失败")}finally{Q.value=!1}},ye=o=>{y.pageSize=o,S()},Ne=o=>{y.pageNumber=o,S()},Z=o=>{l.mafactory=o.descr,l.mafactoryId=o.id,U.value=!1},ve=o=>{Z(o)},T=p(""),ee=()=>{T.value="woNo",V.value=!0,B()},te=()=>{T.value="contractNo",V.value=!0,B()},ae=()=>{T.value="ipoNo",V.value=!0,B()},we=o=>{switch(T.value){case"contractNo":l.contractNo=o.contractNo||"";break;case"woNo":l.woNo=o.woNo||"";break;case"ipoNo":l.ipoNo=o.ipoNo||"";break}V.value=!1},B=async(o="")=>{O.value=!0;try{const e=await tt({pageNumber:1,pageSize:10,woNo:o});P.value=e.data.page.list,A.value=e.data.page.totalRow}catch(e){console.error("获取合同号列表失败",e),b.error("获取合同号列表失败")}finally{O.value=!1}},c=async()=>{L.value=!0;try{const o=await He(i);K.value=o.data.page.list,I.value=o.data.page.totalRow}catch(o){console.error("获取数据列表失败",o),b.error("获取数据列表失败")}finally{L.value=!1}},Ve=o=>{i.pageSize=o,c()},xe=o=>{i.pageNumber=o,c()},le=()=>{C.value&&C.value.resetFields(),F.value&&F.value.clearFiles(),R.value=[],Object.assign(l,{id:void 0,contractNo:"",woNo:"",ipoNo:"",mafactory:"",mafactoryId:"",maQuality:"",orderno:"",matRecheckNo:"",testType:"",testResult:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",writeTime:"",writer:E(),status:0,isdelete:0,basno:""})},ke=()=>{i.contractNo="",i.woNo="",i.ipoNo="",i.mafactory="",i.maQuality="",i.orderno="",i.matRecheckNo="",i.pageNumber=1,c()},Ce=async()=>{h.value="add",le(),l.writer=z.descr||"未知用户";try{if(D.value)l.basno=D.value,D.value="";else{const o=await me("bgxjsbxjfc");o.code===200?l.basno=o.data.fullNoNyName:b.warning("获取单据号失败，可手动填写")}}catch(o){console.error("获取单据号异常",o),b.error("获取单据号失败")}x.value=!0},Se=async o=>{h.value="edit";const e=await Ge({id:o.id});Object.assign(l,e.data.bgxjsbxjFc),l.writer||(l.writer=z.descr||"未知用户");try{JSON.parse(l.certificate)}catch{if(l.certificate){const u=l.certificate.split("-");l.certificate=JSON.stringify(u.map(N=>({name:N.split("/").pop(),url:`/api/upload/${N}`})))}else l.certificate="[]"}R.value=JSON.parse(l.certificate),x.value=!0},je=o=>{Ee.confirm(`确认删除数据"${o.no}"吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await et({id:o.id}),b.success("删除成功"),c()}catch(e){console.error("删除数据失败",e),b.error("删除数据失败")}}).catch(()=>{})},_e=()=>{C.value&&C.value.validate(async o=>{if(o)try{if(!l.basno){b.error("单据号未生成，请刷新重试");return}const e=new Date,n=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),N=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),M=String(e.getMinutes()).padStart(2,"0"),$=String(e.getSeconds()).padStart(2,"0");if(l.writeTime=`${n}-${u}-${N} ${s}:${M}:${$}`,h.value==="add"){await Xe(l),b.success("新增成功");try{const d=await me("bgxjsbxjfc");d.code===200&&(D.value=d.data.fullNoNyName)}catch(d){console.error("获取新单据号异常",d)}}else await Ze(l),b.success("修改成功");x.value=!1,c()}catch(e){console.error("保存数据失败",e),b.error("保存数据失败")}})},D=p(""),ze=async o=>{const e=new FormData;e.append("file",o.raw);try{const n=await Ie(e);if(n.success&&n.data&&n.data.url){const u=ge+n.data.url,N=JSON.parse(l.certificate);N.push({name:o.name,url:u}),l.certificate=JSON.stringify(N),R.value.push({name:o.name,url:u}),b.success(`${o.name} 上传成功`)}else throw new Error(n.msg||"文件上传失败")}catch(n){console.error("文件上传失败",n),b.error(`${o.name} 上传失败`),F.value.clearFiles()}},Ue=o=>{const e=JSON.parse(l.certificate);e.splice(o,1),l.certificate=JSON.stringify(e),R.value.splice(o,1)},oe=o=>{window.open(o,"_blank")};return Oe(()=>{c()}),(o,e)=>{const n=f("el-input"),u=f("el-button"),N=f("el-icon"),s=f("el-table-column"),M=f("el-table"),$=f("el-pagination"),d=f("el-form-item"),re=f("el-date-picker"),he=f("el-upload"),Fe=f("el-col"),Re=f("el-row"),Te=f("el-form"),ne=f("el-dialog"),se=Qe("loading");return w(),k("div",at,[j("div",lt,[t(n,{modelValue:i.mafactory,"onUpdate:modelValue":e[0]||(e[0]=a=>i.mafactory=a),placeholder:"请输入原材料制造商查询",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),t(n,{modelValue:i.orderno,"onUpdate:modelValue":e[1]||(e[1]=a=>i.orderno=a),placeholder:"请输入入库单号查询",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),t(n,{modelValue:i.maQuality,"onUpdate:modelValue":e[2]||(e[2]=a=>i.maQuality=a),placeholder:"请输入辅材类型",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),t(n,{modelValue:i.matRecheckNo,"onUpdate:modelValue":e[3]||(e[3]=a=>i.matRecheckNo=a),placeholder:"请输入来料检验批次号",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),t(u,{type:"primary",onClick:c},{default:r(()=>e[26]||(e[26]=[g("搜索")])),_:1}),t(u,{type:"warning",onClick:ke},{default:r(()=>[t(N,null,{default:r(()=>[t(Y(qe))]),_:1}),e[27]||(e[27]=g(" 刷新 "))]),_:1}),t(u,{type:"primary",style:{"margin-left":"auto"},onClick:Ce},{default:r(()=>e[28]||(e[28]=[g("新增")])),_:1})]),ie((w(),ue(M,{data:K.value,border:"",style:{width:"100%"}},{default:r(()=>[t(s,{type:"index",label:"序号",width:"80"}),t(s,{prop:"basno",label:"单据号"}),t(s,{prop:"contractNo",label:"合同编号"}),t(s,{prop:"woNo",label:"生产工单号"}),t(s,{prop:"ipoNo",label:"生产订单号"}),t(s,{prop:"writer",label:"录入人"}),t(s,{prop:"writeTime",label:"录入时间"}),t(s,{prop:"mafactory",label:"原材料制造商"}),t(s,{prop:"orderno",label:"入库单号"}),t(s,{prop:"matRecheckNo",label:"来料检验批次号"}),t(s,{prop:"maQuality",label:"辅材类型"}),t(s,{prop:"testType",label:"试验类型"}),t(s,{prop:"testResult",label:"试验结果"}),t(s,{prop:"leavefactoryDate",label:"原材料出厂检测日期",width:"120"}),t(s,{prop:"detectionTime",label:"原材料入厂检测日期",width:"120"}),t(s,{prop:"certificate",label:"质量证明书"},{default:r(({row:a})=>[(w(!0),k(de,null,pe(JSON.parse(a.certificate||"[]"),(v,q)=>(w(),k("div",{key:q},[t(Y(ce),{content:v.name,placement:"top"},{default:r(()=>[j("span",{class:"file-link",onClick:dt=>oe(v.url,v.name)},"打开文件",8,ot)]),_:2},1032,["content"])]))),128))]),_:1}),t(s,{label:"操作",width:"200"},{default:r(({row:a})=>[t(u,{type:"primary",size:"small",onClick:v=>Se(a)},{default:r(()=>e[29]||(e[29]=[g("编辑")])),_:2},1032,["onClick"]),t(u,{type:"danger",size:"small",onClick:v=>je(a)},{default:r(()=>e[30]||(e[30]=[g("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[se,L.value]]),j("div",rt,[t($,{"current-page":i.pageNumber,"onUpdate:currentPage":e[4]||(e[4]=a=>i.pageNumber=a),"page-size":i.pageSize,"onUpdate:pageSize":e[5]||(e[5]=a=>i.pageSize=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:I.value,onSizeChange:Ve,onCurrentChange:xe},null,8,["current-page","page-size","total"])]),t(ne,{title:fe.value,modelValue:x.value,"onUpdate:modelValue":e[20]||(e[20]=a=>x.value=a),width:"800px",onClosed:le},{footer:r(()=>[t(u,{onClick:e[19]||(e[19]=a=>x.value=!1)},{default:r(()=>e[37]||(e[37]=[g("取消")])),_:1}),t(u,{type:"primary",onClick:_e},{default:r(()=>e[38]||(e[38]=[g("确定")])),_:1})]),default:r(()=>[t(Te,{ref_key:"formRef",ref:C,model:l,rules:be,"label-width":"140px"},{default:r(()=>[t(Re,{gutter:20},{default:r(()=>[t(Fe,{span:12},{default:r(()=>[t(d,{label:"合同编号",prop:"contractNo"},{default:r(()=>[t(n,{modelValue:l.contractNo,"onUpdate:modelValue":e[6]||(e[6]=a=>l.contractNo=a),placeholder:"选择合同编号",readonly:"",onClick:te},{append:r(()=>[t(u,{onClick:te,size:"small"},{default:r(()=>e[31]||(e[31]=[g("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),t(d,{label:"生产工单号",prop:"woNo"},{default:r(()=>[t(n,{modelValue:l.woNo,"onUpdate:modelValue":e[7]||(e[7]=a=>l.woNo=a),placeholder:"选择生产工单号",readonly:"",onClick:ee},{append:r(()=>[t(u,{onClick:ee,size:"small"},{default:r(()=>e[32]||(e[32]=[g("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),t(d,{label:"生产订单号",prop:"ipoNo"},{default:r(()=>[t(n,{modelValue:l.ipoNo,"onUpdate:modelValue":e[8]||(e[8]=a=>l.ipoNo=a),placeholder:"选择生产订单号",readonly:"",onClick:ae},{append:r(()=>[t(u,{onClick:ae,size:"small"},{default:r(()=>e[33]||(e[33]=[g("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),t(d,{label:"录入人",prop:"writer"},{default:r(()=>[t(n,{modelValue:l.writer,"onUpdate:modelValue":e[9]||(e[9]=a=>l.writer=a),placeholder:"录入人",readonly:""},null,8,["modelValue"])]),_:1}),t(d,{label:"单据号",prop:"basno"},{default:r(()=>[t(n,{modelValue:l.basno,"onUpdate:modelValue":e[10]||(e[10]=a=>l.basno=a),placeholder:"自动生成",readonly:""},null,8,["modelValue"])]),_:1}),t(d,{label:"原材料制造商",prop:"mafactory"},{default:r(()=>[t(n,{modelValue:l.mafactory,"onUpdate:modelValue":e[11]||(e[11]=a=>l.mafactory=a),placeholder:"选择原材料制造商",readonly:"",onClick:X},{append:r(()=>[t(u,{onClick:X,size:"small"},{default:r(()=>e[34]||(e[34]=[g("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),t(d,{label:"入库单号",prop:"orderno"},{default:r(()=>[t(n,{modelValue:l.orderno,"onUpdate:modelValue":e[12]||(e[12]=a=>l.orderno=a),placeholder:"请输入入库单号"},null,8,["modelValue"])]),_:1}),t(d,{label:"来料检验批次号",prop:"matRecheckNo"},{default:r(()=>[t(n,{modelValue:l.matRecheckNo,"onUpdate:modelValue":e[13]||(e[13]=a=>l.matRecheckNo=a),placeholder:"请输入来料检验批次号"},null,8,["modelValue"])]),_:1}),t(d,{label:"辅材类型",prop:"maQuality"},{default:r(()=>[t(n,{modelValue:l.maQuality,"onUpdate:modelValue":e[14]||(e[14]=a=>l.maQuality=a),placeholder:"请输入辅材类型"},null,8,["modelValue"])]),_:1}),t(d,{label:"试验类型",prop:"testType"},{default:r(()=>[t(n,{modelValue:l.testType,"onUpdate:modelValue":e[15]||(e[15]=a=>l.testType=a),placeholder:"请输入试验类型"},null,8,["modelValue"])]),_:1}),t(d,{label:"检验结果",prop:"testResult"},{default:r(()=>[t(n,{modelValue:l.testResult,"onUpdate:modelValue":e[16]||(e[16]=a=>l.testResult=a),placeholder:"请输入检验结果"},null,8,["modelValue"])]),_:1}),t(d,{label:"原材料出厂检测日期",prop:"leavefactoryDate"},{default:r(()=>[t(re,{modelValue:l.leavefactoryDate,"onUpdate:modelValue":e[17]||(e[17]=a=>l.leavefactoryDate=a),type:"date",placeholder:"请选择原材料出厂检测日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(d,{label:"原材料入厂检测日期",prop:"detectionTime"},{default:r(()=>[t(re,{modelValue:l.detectionTime,"onUpdate:modelValue":e[18]||(e[18]=a=>l.detectionTime=a),type:"date",placeholder:"请选择原材料入厂检测日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(d,{label:"质量证明书",prop:"certificate"},{default:r(()=>[t(he,{ref_key:"certificateUpload",ref:F,"auto-upload":!1,"on-change":ze,limit:10,accept:".pdf,.jpg,.jpeg,.png","file-list":[],"show-file-list":!1},{default:r(()=>[t(u,{type:"primary"},{default:r(()=>e[35]||(e[35]=[g("上传文件")])),_:1})]),_:1},512),l.certificate?(w(),k("div",nt,[(w(!0),k(de,null,pe(JSON.parse(l.certificate),(a,v)=>(w(),k("div",{key:v,class:"uploaded-file"},[t(Y(ce),{content:a.name,placement:"top"},{default:r(()=>[j("span",{class:"file-link",onClick:q=>oe(a.url,a.name)},Je(a.name),9,st)]),_:2},1032,["content"]),t(u,{type:"danger",size:"mini",onClick:q=>Ue(v)},{default:r(()=>e[36]||(e[36]=[g("删除")])),_:2},1032,["onClick"])]))),128))])):Ye("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),t(Pe,{modelValue:V.value,"onUpdate:modelValue":e[21]||(e[21]=a=>V.value=a),onSelect:we,woNoList:P.value,totalWoNo:A.value,loadingWoNo:O.value,onSearch:B},null,8,["modelValue","woNoList","totalWoNo","loadingWoNo"]),t(ne,{title:"选择原材料制造商",modelValue:U.value,"onUpdate:modelValue":e[25]||(e[25]=a=>U.value=a),width:"600px"},{default:r(()=>[t(n,{modelValue:y.descr,"onUpdate:modelValue":e[22]||(e[22]=a=>y.descr=a),placeholder:"请输入供应商名称查询",style:{"margin-bottom":"10px"},clearable:"",onClear:S,onKeyup:_(S,["enter"])},null,8,["modelValue"]),ie((w(),ue(M,{data:H.value,border:"",style:{width:"100%"},onRowClick:ve},{default:r(()=>[t(s,{prop:"no",label:"供应商编号"}),t(s,{prop:"descr",label:"供应商名称"}),t(s,{prop:"contactname",label:"联系人"}),t(s,{prop:"phone",label:"联系电话"}),t(s,{label:"操作"},{default:r(({row:a})=>[t(u,{type:"primary",size:"small",onClick:v=>Z(a)},{default:r(()=>e[39]||(e[39]=[g("选择")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[se,Q.value]]),j("div",it,[t($,{"current-page":y.pageNumber,"onUpdate:currentPage":e[23]||(e[23]=a=>y.pageNumber=a),"page-size":y.pageSize,"onUpdate:pageSize":e[24]||(e[24]=a=>y.pageSize=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:G.value,onSizeChange:ye,onCurrentChange:Ne},null,8,["current-page","page-size","total"])])]),_:1},8,["modelValue"])])}}},bt=$e(ut,[["__scopeId","data-v-3b3f6b79"]]);export{bt as default};

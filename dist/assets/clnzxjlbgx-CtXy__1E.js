import{O as A,P as qe,Q as Pe,R as Le,_ as Ie,f as Ye,k as Oe,r as s,g as Je,s as Ae,h as g,G as He,o as v,c as y,a as b,b as l,e as Ke,w as r,i as u,W as re,H as Qe,l as Ge,q as M,F as ne,m as ie,p as Xe,x as Ze,ah as el,E as m,A as ll,B as al}from"./index-Bwbtb0V1.js";import{a as tl}from"./file-CLvCJErd.js";import{W as se,S as ue,C as ol,I as rl}from"./SupplierDialog-pe6d4KWF.js";import"./plshengchangongdan-BS-Hu3DG.js";import"./basorg-D9Q4sOwh.js";function nl(f){return A("/clnzxjlbgx/getpage",f)}function il(f){return A("/clnzxjlbgx/get",f)}function sl(f){return qe("/clnzxjlbgx/save",f)}function ul(f){return Pe("/clnzxjlbgx/update",f)}function dl(f){return Le("/clnzxjlbgx/delete",f)}function de(f){return A("/Basno/getNewNoNyName",{basname:f})}const pl={class:"clnzxjlbgx-management"},ml={class:"action-bar"},cl=["onClick"],fl={class:"pagination-container"},gl={key:0,class:"uploaded-files"},vl={key:0,class:"preview-container"},yl=["src"],bl={key:1,class:"preview-container"},wl=["src"],Vl=["href"],xl={key:2,class:"preview-container"},Nl={style:{"text-align":"center",padding:"40px"}},kl={__name:"clnzxjlbgx",setup(f){const pe=Ye(),H=Oe(()=>({username:pe.realName||"未登录"})),C=al,o=s(R()),d=Je({matRecheckNo:"",mafactory:"",woNo:"",pageNumber:1,pageSize:10}),D=s([]),K=s(0),q=s(!1),N=s(!1),P=s("新增耐张线夹铝包钢线"),L=s("add"),$=s(null),I=s(!1),S=s(!1),j=s(!1),T=s(!1),F=s(!1),z=s(!1),h=s(!1),Y=s(null),Q=()=>{T.value=!0},G=()=>{F.value=!0},me=t=>{o.value.contractNo=t.contractNo,T.value=!1},ce=t=>{o.value.ipoNo=t.ipoNo,F.value=!1},w=s([]),U=s(!1),V=s(""),_=s(""),W=s("");function O(t){if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e.map(n=>({...n,url:n.url.startsWith("http")?n.url:C+n.url})):[]}catch{return console.warn("Failed to parse certificate JSON for display:",t),[]}}const X=(t,e="")=>{const n=t||e;return/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?"image":/\.pdf$/i.test(n)?"pdf":"other"},fe=t=>{const e=X(t.url,t.name);e==="image"||e==="pdf"?ge(t.url,t.name,e):J(t.url,t.name)},ge=(t,e="",n="")=>{const i=t.startsWith("http")?t:C+t;V.value=i,W.value=e,_.value=n||X(i,e),U.value=!0},J=(t,e="")=>{try{const n=t.startsWith("http")?t:C+t,i=document.createElement("a");i.href=n,i.download=e||"质量证明书",i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i),m.success("文件下载已开始")}catch(n){console.error("下载文件失败:",n),m.error("文件下载失败，请稍后重试"),window.open(t.startsWith("http")?t:C+t,"_blank")}},Z=()=>{U.value=!1,V.value="",W.value="",_.value=""},ve=()=>{m.error("图片加载失败")},ye=()=>{m.error("PDF预览失败，请尝试下载文件")},be=async t=>{if(w.value.length>=3){m.warning("最多只能上传3个质量证明书"),Y.value.clearFiles();return}const e=new FormData;e.append("file",t.raw);try{const n=await tl(e);if(n.success&&n.data&&n.data.url){const i=C+n.data.url,p=JSON.parse(o.value.certificate||"[]");p.push({name:t.name,url:i}),o.value.certificate=JSON.stringify(p),w.value.push({name:t.name,url:i}),m.success(`${t.name} 上传成功`)}else throw new Error(n.msg||"文件上传失败")}catch(n){console.error("文件上传失败",n),m.error(`${t.name} 上传失败`),Y.value.clearFiles()}},we=t=>{const e=JSON.parse(o.value.certificate||"[]");e.splice(t,1),o.value.certificate=JSON.stringify(e),w.value.splice(t,1)};function R(){return{id:void 0,matRecheckNo:"",orderno:"",size:"",singleWireStrength:"",mafactory:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",contractNo:"",woNo:"",ipoNo:"",writer:"",writeTime:"",basno:"",flag:"",status:"",memo:"",type:""}}const Ve={matRecheckNo:[{required:!0,message:"请填写来料检验批次号",trigger:"blur"}],orderno:[{required:!0,message:"请填写入库单号",trigger:"blur"}],size:[{required:!0,message:"请填写尺寸",trigger:"blur"}],singleWireStrength:[{required:!0,message:"请填写力学性能-单丝强度",trigger:"blur"}],mafactory:[{required:!0,message:"请选择原材料制造商",trigger:"change"}],leavefactoryDate:[{required:!0,message:"请选择原材料出厂检测日期",trigger:"change"}],detectionTime:[{required:!0,message:"请选择原材料入厂检测日期",trigger:"change"}],certificate:[{required:!0,message:"请上传质量证明书",trigger:"change"}],woNo:[{max:50,message:"请选择生产工单号",trigger:"change"}],contractNo:[{required:!0,message:"合同编号不能为空",trigger:"change"}],ipoNo:[{max:50,message:"生产订单号不能为空",trigger:"change"}],writer:[{required:!0,message:"录入人不能为空",trigger:"blur"}],basno:[{max:50,message:"请获取单据号",trigger:"blur"}]},k=async()=>{q.value=!0;try{const t=await nl(d);D.value=t.data.page.list,K.value=t.data.page.totalRow,D.value.length>0?console.log("第一条数据的单据号:",D.value[0].basno):console.log("列表为空")}catch{m.error("获取数据失败")}finally{q.value=!1}},E=()=>{d.matRecheckNo="",d.mafactory="",d.woNo="",d.pageNumber=1,k()},xe=t=>{d.pageSize=t,k()},Ne=t=>{d.pageNumber=t,k()},ke=async()=>{if(P.value="新增耐张线夹铝包钢线",L.value="add",o.value=R(),o.value.writer=H.value.username,o.value.writeTime=le(new Date),B.value)o.value.basno=B.value,B.value="";else try{const t=await de("clnzxjlbgx");t.code===200?o.value.basno=t.data.fullNoNyName:m.warning("获取单据号失败，可手动填写")}catch(t){console.error("获取单据号异常",t),m.error("获取单据号失败")}w.value=[],o.value.certificate="[]",N.value=!0},Ce=async t=>{P.value="编辑耐张线夹铝包钢线",L.value="edit";try{const e=await il({id:t.id});e&&e.code===200&&e.data&&e.data.clNzxjLbgx&&(o.value={...R(),...e.data.clNzxjLbgx}),w.value=O(o.value.certificate),N.value=!0}catch(e){console.error("获取详情失败",e)}},Se=t=>{ll.confirm("确认删除该条铝包钢线数据吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{await dl({id:t.id}),m.success("删除成功"),E()}).catch(()=>{})},ee=()=>{j.value=!0},ze=t=>{d.mafactory=t,S.value=!1},he=t=>{d.woNo=t.woNo,h.value=!1},Ue=()=>{d.mafactory=""},De=()=>{d.woNo=""},$e=t=>{o.value.mafactory=t,z.value=!1},je=async t=>{o.value.woNo=t.woNo,j.value=!1},Te=()=>{$.value.validate(async t=>{if(t){I.value=!0;try{if(o.value.certificate=JSON.stringify(w.value),!o.value.basno){m.error("单据号未生成，请刷新重试");return}if(L.value==="add"){o.value.writer=H.value.username,o.value.writeTime=le(new Date),await sl(o.value),m.success("新增成功");try{const e=await de("clnzxjlbgx");e.code===200&&(B.value=e.data.fullNoNyName)}catch(e){console.error("获取新单据号异常",e)}E()}else await ul(o.value),m.success("修改成功"),E();N.value=!1}catch(e){console.error("保存失败:",e),m.error("保存失败: "+(e.message||e))}finally{I.value=!1}}})},B=s("");function le(t){if(!t)return"";const e=new Date(t),n=i=>i.toString().padStart(2,"0");return`${e.getFullYear()}-${n(e.getMonth()+1)}-${n(e.getDate())} ${n(e.getHours())}:${n(e.getMinutes())}:${n(e.getSeconds())}`}const Fe=()=>{o.value=R(),w.value=[],Z(),$.value&&$.value.resetFields()};return Ae(k),(t,e)=>{const n=g("el-input"),i=g("el-button"),p=g("el-table-column"),_e=g("el-table"),We=g("el-pagination"),c=g("el-form-item"),ae=g("el-date-picker"),Re=g("el-upload"),Ee=g("el-form"),te=g("el-dialog"),Be=g("el-icon"),Me=He("loading");return v(),y("div",pl,[b("div",ml,[l(n,{modelValue:d.matRecheckNo,"onUpdate:modelValue":e[0]||(e[0]=a=>d.matRecheckNo=a),placeholder:"来料检验批次号",style:{width:"200px","margin-right":"10px"},clearable:"",onKeyup:Ke(k,["enter"])},null,8,["modelValue"]),l(n,{modelValue:d.mafactory,"onUpdate:modelValue":e[2]||(e[2]=a=>d.mafactory=a),placeholder:"原材料制造商",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[3]||(e[3]=re(a=>S.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:Ue},{append:r(()=>[l(i,{onClick:e[1]||(e[1]=a=>S.value=!0),size:"small"},{default:r(()=>e[35]||(e[35]=[u("选择")])),_:1})]),_:1},8,["modelValue"]),l(n,{modelValue:d.woNo,"onUpdate:modelValue":e[5]||(e[5]=a=>d.woNo=a),placeholder:"生产工单号",readonly:"",style:{width:"200px","margin-right":"10px",cursor:"pointer"},onClick:e[6]||(e[6]=re(a=>h.value=!0,["stop"])),"suffix-icon":"el-icon-search",clearable:"",onClear:De},{append:r(()=>[l(i,{onClick:e[4]||(e[4]=a=>h.value=!0),size:"small"},{default:r(()=>e[36]||(e[36]=[u("选择")])),_:1})]),_:1},8,["modelValue"]),l(i,{type:"primary",onClick:k},{default:r(()=>e[37]||(e[37]=[u("搜索")])),_:1}),l(i,{type:"warning",onClick:E,style:{"margin-left":"10px"}},{default:r(()=>e[38]||(e[38]=[u("重置")])),_:1}),l(i,{type:"primary",style:{"margin-left":"auto"},onClick:ke},{default:r(()=>e[39]||(e[39]=[u("新增耐张线夹铝包钢线")])),_:1})]),Qe((v(),Ge(_e,{data:D.value,border:"",style:{width:"100%"}},{default:r(()=>[l(p,{type:"index",label:"序号",width:"70"}),l(p,{prop:"basno",label:"单据号"}),l(p,{prop:"matRecheckNo",label:"来料检验批次号"}),l(p,{prop:"orderno",label:"入库单号"}),l(p,{prop:"size",label:"尺寸"},{default:r(({row:a})=>[u(M(a.size?`${a.size} mm`:""),1)]),_:1}),l(p,{prop:"singleWireStrength",label:"力学性能-单丝强度"},{default:r(({row:a})=>[u(M(a.singleWireStrength?`${a.singleWireStrength} MPa`:""),1)]),_:1}),l(p,{prop:"mafactory",label:"原材料制造商"}),l(p,{prop:"leavefactoryDate",label:"原材料出厂检测日期",width:"130"}),l(p,{prop:"detectionTime",label:"原材料入厂检测日期",width:"130"}),l(p,{label:"质量证明书"},{default:r(({row:a})=>[(v(!0),y(ne,null,ie(O(a.certificate),(x,oe)=>(v(),y("div",{key:oe},[b("span",{class:"file-link",onClick:Cl=>fe(x)},M(x.name),9,cl)]))),128))]),_:1}),l(p,{prop:"contractNo",label:"合同编号"}),l(p,{prop:"woNo",label:"生产工单号"}),l(p,{prop:"ipoNo",label:"生产订单号"}),l(p,{prop:"writer",label:"录入人"}),l(p,{prop:"writeTime",label:"录入时间",width:"150"}),l(p,{label:"操作",width:"220",fixed:"right"},{default:r(({row:a})=>[l(i,{type:"primary",size:"small",onClick:x=>Ce(a)},{default:r(()=>e[40]||(e[40]=[u("编辑")])),_:2},1032,["onClick"]),l(i,{type:"danger",size:"small",onClick:x=>Se(a)},{default:r(()=>e[41]||(e[41]=[u("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Me,q.value]]),b("div",fl,[l(We,{"current-page":d.pageNumber,"onUpdate:currentPage":e[7]||(e[7]=a=>d.pageNumber=a),"page-size":d.pageSize,"onUpdate:pageSize":e[8]||(e[8]=a=>d.pageSize=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:K.value,onSizeChange:xe,onCurrentChange:Ne},null,8,["current-page","page-size","total"])]),l(te,{title:P.value,modelValue:N.value,"onUpdate:modelValue":e[26]||(e[26]=a=>N.value=a),width:"700px",onClosed:Fe},{footer:r(()=>[l(i,{onClick:e[23]||(e[23]=a=>N.value=!1)},{default:r(()=>e[49]||(e[49]=[u("取消")])),_:1}),l(i,{type:"primary",onClick:Te,loading:I.value},{default:r(()=>e[50]||(e[50]=[u("保存")])),_:1},8,["loading"])]),default:r(()=>[l(Ee,{ref_key:"formRef",ref:$,model:o.value,rules:Ve,"label-width":"120px"},{default:r(()=>[l(c,{label:"生产工单号",prop:"woNo"},{default:r(()=>[l(n,{modelValue:o.value.woNo,"onUpdate:modelValue":e[9]||(e[9]=a=>o.value.woNo=a),placeholder:"请选择生产工单号",readonly:"",style:{width:"calc(100% - 80px)"},onClick:ee},{append:r(()=>[l(i,{onClick:ee,size:"small"},{default:r(()=>e[42]||(e[42]=[u("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"合同编号",prop:"contractNo"},{default:r(()=>[l(n,{modelValue:o.value.contractNo,"onUpdate:modelValue":e[10]||(e[10]=a=>o.value.contractNo=a),placeholder:"请选择合同编号",readonly:"",onClick:Q},{append:r(()=>[l(i,{onClick:Q,size:"small"},{default:r(()=>e[43]||(e[43]=[u("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"生产订单号",prop:"ipoNo"},{default:r(()=>[l(n,{modelValue:o.value.ipoNo,"onUpdate:modelValue":e[11]||(e[11]=a=>o.value.ipoNo=a),placeholder:"请选择生产订单号",readonly:"",onClick:G},{append:r(()=>[l(i,{onClick:G,size:"small"},{default:r(()=>e[44]||(e[44]=[u("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"单据号",prop:"basno"},{default:r(()=>[l(n,{modelValue:o.value.basno,"onUpdate:modelValue":e[12]||(e[12]=a=>o.value.basno=a),placeholder:"自动生成",readonly:""},null,8,["modelValue"])]),_:1}),l(c,{label:"来料检验批次号",prop:"matRecheckNo"},{default:r(()=>[l(n,{modelValue:o.value.matRecheckNo,"onUpdate:modelValue":e[13]||(e[13]=a=>o.value.matRecheckNo=a),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(c,{label:"入库单号",prop:"orderno"},{default:r(()=>[l(n,{modelValue:o.value.orderno,"onUpdate:modelValue":e[14]||(e[14]=a=>o.value.orderno=a),maxlength:"48"},null,8,["modelValue"])]),_:1}),l(c,{label:"尺寸（mm）",prop:"size"},{default:r(()=>[l(n,{modelValue:o.value.size,"onUpdate:modelValue":e[15]||(e[15]=a=>o.value.size=a),maxlength:"50",placeholder:"请输入尺寸(mm)"},null,8,["modelValue"])]),_:1}),l(c,{label:"力学性能-单丝强度（MPa）",prop:"singleWireStrength"},{default:r(()=>[l(n,{modelValue:o.value.singleWireStrength,"onUpdate:modelValue":e[16]||(e[16]=a=>o.value.singleWireStrength=a),maxlength:"50",placeholder:"请输入单丝强度(MPa)"},null,8,["modelValue"])]),_:1}),l(c,{label:"原材料制造商",prop:"mafactory"},{default:r(()=>[l(n,{modelValue:o.value.mafactory,"onUpdate:modelValue":e[18]||(e[18]=a=>o.value.mafactory=a),placeholder:"请选择原材料制造商",readonly:"",style:{cursor:"pointer"},onClick:z.value},{append:r(()=>[l(i,{onClick:e[17]||(e[17]=a=>z.value=!0),size:"small"},{default:r(()=>e[45]||(e[45]=[u("选择")])),_:1})]),_:1},8,["modelValue","onClick"])]),_:1}),l(c,{label:"原材料出厂检测日期",prop:"leavefactoryDate"},{default:r(()=>[l(ae,{modelValue:o.value.leavefactoryDate,"onUpdate:modelValue":e[19]||(e[19]=a=>o.value.leavefactoryDate=a),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"原材料入厂检测日期",prop:"detectionTime"},{default:r(()=>[l(ae,{modelValue:o.value.detectionTime,"onUpdate:modelValue":e[20]||(e[20]=a=>o.value.detectionTime=a),type:"date","value-format":"YYYY-MM-DD",placeholder:"选择日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(c,{label:"质量证明书",prop:"certificate"},{default:r(()=>[l(Re,{ref_key:"certificateUpload",ref:Y,"auto-upload":!1,"on-change":be,limit:3,accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png","file-list":[],"show-file-list":!1},{default:r(()=>[l(i,{type:"primary"},{default:r(()=>e[46]||(e[46]=[u("上传质量证明书")])),_:1}),e[47]||(e[47]=b("div",{class:"el-upload__tip"},"支持 pdf、doc、docx、xls、xlsx、jpg、jpeg、png 等格式，最多3个质量证明书",-1))]),_:1},512),o.value.certificate?(v(),y("div",gl,[(v(!0),y(ne,null,ie(O(o.value.certificate),(a,x)=>(v(),y("div",{key:x,class:"uploaded-file"},[u(M(a.name)+" ",1),l(i,{type:"danger",size:"mini",onClick:oe=>we(x)},{default:r(()=>e[48]||(e[48]=[u("删除")])),_:2},1032,["onClick"])]))),128))])):Xe("",!0)]),_:1}),l(c,{label:"录入人",prop:"writer"},{default:r(()=>[l(n,{modelValue:o.value.writer,"onUpdate:modelValue":e[21]||(e[21]=a=>o.value.writer=a),disabled:""},null,8,["modelValue"])]),_:1}),l(c,{label:"录入时间",prop:"writeTime"},{default:r(()=>[l(n,{modelValue:o.value.writeTime,"onUpdate:modelValue":e[22]||(e[22]=a=>o.value.writeTime=a),disabled:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),l(se,{modelValue:j.value,"onUpdate:modelValue":e[24]||(e[24]=a=>j.value=a),onSelect:je},null,8,["modelValue"]),l(ue,{modelValue:z.value,"onUpdate:modelValue":e[25]||(e[25]=a=>z.value=a),onSelect:$e},null,8,["modelValue"])]),_:1},8,["title","modelValue"]),l(te,{title:"质量证明书预览",modelValue:U.value,"onUpdate:modelValue":e[30]||(e[30]=a=>U.value=a),width:"80%","close-on-click-modal":!1,"before-close":Z},{footer:r(()=>[l(i,{onClick:e[28]||(e[28]=a=>U.value=!1)},{default:r(()=>e[54]||(e[54]=[u("关闭")])),_:1}),l(i,{type:"primary",onClick:e[29]||(e[29]=a=>J(V.value,W.value))},{default:r(()=>e[55]||(e[55]=[u(" 下载 ")])),_:1})]),default:r(()=>[_.value==="image"?(v(),y("div",vl,[b("img",{src:V.value,alt:"质量证明书",style:{"max-width":"100%","max-height":"70vh",display:"block",margin:"0 auto"},onError:ve},null,40,yl)])):_.value==="pdf"?(v(),y("div",bl,[b("iframe",{src:V.value,width:"100%",height:"600px",frameborder:"0",onError:ye},[e[51]||(e[51]=u(" 您的浏览器不支持PDF预览，请")),b("a",{href:V.value,target:"_blank"},"点击此处下载",8,Vl)],40,wl)])):(v(),y("div",xl,[b("div",Nl,[l(Be,{size:"64",color:"#909399"},{default:r(()=>[l(Ze(el))]),_:1}),e[53]||(e[53]=b("p",{style:{margin:"20px 0",color:"#606266"}},"此文件类型不支持在线预览",-1)),l(i,{type:"primary",onClick:e[27]||(e[27]=a=>J(V.value,W.value))},{default:r(()=>e[52]||(e[52]=[u(" 下载文件 ")])),_:1})])]))]),_:1},8,["modelValue"]),l(se,{modelValue:h.value,"onUpdate:modelValue":e[31]||(e[31]=a=>h.value=a),onSelect:he},null,8,["modelValue"]),l(ol,{modelValue:T.value,"onUpdate:modelValue":e[32]||(e[32]=a=>T.value=a),onSelect:me},null,8,["modelValue"]),l(rl,{modelValue:F.value,"onUpdate:modelValue":e[33]||(e[33]=a=>F.value=a),onSelect:ce},null,8,["modelValue"]),l(ue,{modelValue:S.value,"onUpdate:modelValue":e[34]||(e[34]=a=>S.value=a),onSelect:ze},null,8,["modelValue"])])}}},$l=Ie(kl,[["__scopeId","data-v-0977cf9c"]]);export{$l as default};

import{_ as Ie,g as ee,r as m,k as Ne,s as Me,h as v,G as ze,o as k,c as O,a as q,b as l,e as Te,w as s,i as g,H as ne,l as $,x as Fe,B as T,q as oe,p as ue,F as Be,m as Re,E as i,I as De,J as Ae,L as de,A as Le,M as ie,N as Se}from"./index-DvIhe9Wx.js";import{a as $e,g as Ke,d as Oe,b as qe,u as Ee}from"./user-Bi4eeHg4.js";import{g as Pe}from"./department-Cki7KwLG.js";import{u as je}from"./file-dcKrrYHU.js";const Ge={class:"user-management"},He={class:"action-bar"},Je={key:1},We={class:"pagination-container"},Qe={class:"avatar-upload"},Xe={key:1,class:"no-avatar"},Ye={key:0},Ze={__name:"user",setup(ea){const h=ee({pageNumber:1,pageSize:10,username:""}),ae=m([]),le=m(0),H=m(!1),E=m([]),b=m([]),R=m(null),J=m(!1),te=m(0),W=m(!1),D=m(!1),C=m("add"),ce=Ne(()=>C.value==="add"?"新增用户":"编辑用户"),K=m(null),A=m(null),U=m([]),x=m(""),_=m(""),o=ee({id:void 0,username:"",password:"",departmentid:null,status:0,flag:null,memo:"",rule:"",type:"",descr:"",phone:"",category:"",fax:"",avatar:""}),P=m(!1),y=ee({id:void 0,username:""}),w=m([]),me={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{max:255,message:"长度不能超过255个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{max:255,message:"长度不能超过255个字符",trigger:"blur"}],descr:[{required:!0,message:"请输入姓名",trigger:"blur"},{max:255,message:"长度不能超过255个字符",trigger:"blur"}],departmentid:[{required:!0,message:"请选择部门",trigger:"change"}],category:[{max:255,message:"长度不能超过255个字符",trigger:"blur"}],phone:[{max:255,message:"长度不能超过255个字符",trigger:"blur"},{pattern:/^[0-9-+\s]*$/,message:"请输入有效的手机号",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}],memo:[{max:255,message:"长度不能超过255个字符",trigger:"blur"}]},I=async()=>{H.value=!0;try{const a=await $e(h);ae.value=a.data.page.list.map(e=>{const n=E.value.find(r=>r.code==e.departmentid);return{...e,departmentName:(n==null?void 0:n.name)||"未知"}}),le.value=a.data.page.totalRow}catch(a){console.error("获取用户列表失败",a),i.error("获取用户列表失败")}finally{H.value=!1}},pe=async()=>{try{const a=await Pe();console.log("获取部门选项",a.data.options),a.success&&a.data.options&&(E.value=a.data.options,console.log("departmentOptions.value",E.value))}catch(a){console.error("获取部门选项失败",a),i.error("获取部门选项失败")}},re=async()=>{J.value=!0;try{const a=await De();a.success&&a.data.menuTree?b.value=a.data.menuTree:i.error("获取菜单树失败")}catch(a){console.error("获取菜单树失败",a),i.error("获取菜单树失败")}finally{J.value=!1}},Q=async a=>{try{const e=await Se({userId:a});if(await ie(),!R.value){console.error("菜单树组件未找到"),i.error("菜单树组件未找到");return}if(R.value.setCheckedKeys([]),e.success&&e.data&&e.data.list&&Array.isArray(e.data.list)){const n=e.data.list.map(r=>r.menuid).filter(r=>r!=null);w.value=[...n],n.length>0&&R.value.setCheckedKeys(n)}else w.value=[]}catch(e){console.error("获取用户菜单权限失败",e),i.error("获取用户菜单权限失败")}},X=(a,e,n=null)=>{for(const r of a){if(r.id===e)return n;if(r.children&&r.children.length){const c=X(r.children,e,r.id);if(c)return c}}return null},Y=a=>{const e=[];return a.children&&a.children.length>0&&a.children.forEach(n=>{e.push(n.id),e.push(...Y(n))}),e},ve=async(a,e)=>{if(!y.id||W.value)return;const n=a.id,r=e.checkedKeys,c=[...w.value];let L=r.filter(u=>!c.includes(u)),p=c.filter(u=>!r.includes(u));const S=X(b.value,n);S&&L.includes(n)&&!c.includes(S)&&L.push(S);const j=p.find(u=>{const d=F(b.value,u);return d&&d.children&&d.children.length>0});if(j){const u=F(b.value,j);if(u){const V=Y(u).filter(N=>c.includes(N));p=[...new Set([...p,...V])]}}if(!(L.length===0&&p.length===0)){W.value=!0;try{for(const u of L){const d=await Ae({userId:y.id,menuId:u});if(d.success){w.value.includes(u)||w.value.push(u);const V=F(b.value,u),N=V?V.title:u;i.success(`已添加"${N}"权限`)}else i.error(d.message||"添加权限失败")}for(const u of p){const d=X(b.value,u);let V=[];if(d&&c.includes(d)&&!p.includes(d)){const f=F(b.value,d);f&&Y(f).filter(B=>r.includes(B)&&B!==u).length===0&&V.push(d)}const N=await de({userId:y.id,menuId:u});if(N.success){const f=w.value.indexOf(u);f>-1&&w.value.splice(f,1);const M=F(b.value,u),z=M?M.title:u;i.success(`已移除"${z}"权限`)}else i.error(N.message||"移除权限失败");for(const f of V){if(!w.value.includes(f))continue;const M=await de({userId:y.id,menuId:f});if(M.success){const z=w.value.indexOf(f);z>-1&&w.value.splice(z,1);const B=F(b.value,f),G=B?B.title:f;i.success(`已移除"${G}"权限`)}else i.error(M.message||"移除父菜单权限失败")}}await Q(y.id)}catch(u){console.error("更新权限失败",u),i.error("更新权限失败: "+(u.message||"未知错误")),await Q(y.id)}finally{W.value=!1}}},F=(a,e)=>{for(const n of a){if(n.id===e)return n;if(n.children&&n.children.length){const r=F(n.children,e);if(r)return r}}return null},fe=a=>{h.pageSize=a,I()},ge=a=>{h.pageNumber=a,I()},Z=()=>{K.value&&K.value.resetFields(),A.value&&A.value.clearFiles(),U.value=[],x.value="",_.value="",Object.assign(o,{id:void 0,username:"",password:"",departmentid:null,status:0,flag:null,memo:"",rule:"",type:"",descr:"",phone:"",category:"",fax:"",avatar:""})},ye=async a=>{const e=a.raw.type.startsWith("image/"),n=a.size/1024/1024<2;if(!e){i.error("请上传图片文件!"),A.value.clearFiles();return}if(!n){i.error("图片大小不能超过2MB!"),A.value.clearFiles();return}const r=new FormData;r.append("file",a.raw);try{const c=await je(r);if(c.success&&c.data&&c.data.url)U.value=[{name:a.name,url:T+c.data.url}],x.value=T+c.data.url,o.avatar=c.data.url,i.success("头像上传成功");else throw new Error(c.msg||"头像上传失败")}catch(c){console.error("头像上传失败",c),i.error("头像上传失败"),U.value=[],x.value=C.value==="edit"&&_.value?T+_.value:"",o.avatar=C.value==="edit"?_.value:"",A.value.clearFiles()}},he=()=>{U.value=[],x.value="",o.avatar=C.value==="edit"?_.value:""},be=()=>{C.value="add",D.value=!0,x.value="",U.value=[]},_e=async a=>{C.value="edit";try{const e=await Ke({id:a.id});Object.assign(o,e.data.user),_.value=o.avatar||"",o.avatar?(x.value=T+o.avatar,U.value=[{name:"avatar",url:T+o.avatar}]):(x.value="",U.value=[]),D.value=!0}catch(e){console.error("获取用户信息失败",e),i.error("获取用户信息失败")}},we=()=>{D.value=!1,C.value==="edit"&&(o.avatar=_.value,x.value=_.value?T+_.value:"",U.value=_.value?[{name:"avatar",url:T+_.value}]:[]),Z()},Ve=a=>{Le.confirm(`确认删除用户"${a.username}"吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Oe({id:a.id}),i.success("删除成功"),I()}catch(e){console.error("删除用户失败",e),i.error("删除用户失败")}}).catch(()=>{})},ke=()=>{K.value&&K.value.validate(async a=>{if(a)try{const e={...o};e.avatar&&typeof e.avatar!="string"&&delete e.avatar,C.value==="add"?(await qe(e),i.success("新增成功")):(await Ee(e),i.success("修改成功")),D.value=!1,Z(),I()}catch(e){console.error("保存用户失败",e),i.error("保存用户失败")}})},xe=async a=>{y.id=a.id,y.username=a.username,te.value++,b.value.length===0&&await re(),P.value=!0,await ie(),await Q(a.id)},Ce=()=>{y.id=void 0,y.username="",w.value=[],R.value&&R.value.setCheckedKeys([])},Ue=()=>{h.username="",h.pageNumber=1,I()};return Me(()=>{pe(),I(),re()}),(a,e)=>{const n=v("el-input"),r=v("el-button"),c=v("Refresh"),L=v("el-icon"),p=v("el-table-column"),S=v("el-image"),j=v("el-table"),u=v("el-pagination"),d=v("el-form-item"),V=v("el-option"),N=v("el-select"),f=v("el-upload"),M=v("el-form"),z=v("el-dialog"),B=v("el-tree"),G=ze("loading");return k(),O("div",Ge,[q("div",He,[l(n,{modelValue:h.username,"onUpdate:modelValue":e[0]||(e[0]=t=>h.username=t),placeholder:"请输入用户名搜索",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:I,onKeyup:Te(I,["enter"])},null,8,["modelValue"]),l(r,{type:"primary",onClick:I},{default:s(()=>e[14]||(e[14]=[g("搜索")])),_:1}),l(r,{type:"warning",onClick:Ue},{default:s(()=>[l(L,null,{default:s(()=>[l(c)]),_:1}),e[15]||(e[15]=g(" 刷新 "))]),_:1}),l(r,{type:"primary",style:{"margin-left":"auto"},onClick:be},{default:s(()=>e[16]||(e[16]=[g("新增用户")])),_:1})]),ne((k(),$(j,{data:ae.value,border:"",style:{width:"100%"}},{default:s(()=>[l(p,{type:"index",label:"序号",width:"80"}),l(p,{prop:"username",label:"用户名"}),l(p,{prop:"descr",label:"姓名"}),l(p,{prop:"departmentName",label:"部门"}),l(p,{prop:"category",label:"岗位"}),l(p,{prop:"phone",label:"手机号"}),l(p,{prop:"memo",label:"备注"}),l(p,{label:"头像",width:"100"},{default:s(({row:t})=>[t.avatar?(k(),$(S,{key:0,src:Fe(T)+t.avatar,style:{width:"40px",height:"40px","border-radius":"50%"},fit:"cover"},null,8,["src"])):(k(),O("span",Je,"无头像"))]),_:1}),l(p,{label:"状态",width:"100"},{default:s(({row:t})=>[g(oe(t.status===0?"正常":"已删除"),1)]),_:1}),l(p,{label:"操作",width:"280"},{default:s(({row:t})=>[l(r,{type:"primary",size:"small",onClick:se=>_e(t)},{default:s(()=>e[17]||(e[17]=[g("编辑")])),_:2},1032,["onClick"]),l(r,{type:"success",size:"small",onClick:se=>xe(t)},{default:s(()=>e[18]||(e[18]=[g("权限设置")])),_:2},1032,["onClick"]),l(r,{type:"danger",size:"small",onClick:se=>Ve(t)},{default:s(()=>e[19]||(e[19]=[g("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[G,H.value]]),q("div",We,[l(u,{"current-page":h.pageNumber,"onUpdate:currentPage":e[1]||(e[1]=t=>h.pageNumber=t),"page-size":h.pageSize,"onUpdate:pageSize":e[2]||(e[2]=t=>h.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:le.value,onSizeChange:fe,onCurrentChange:ge},null,8,["current-page","page-size","total"])]),l(z,{title:ce.value,modelValue:D.value,"onUpdate:modelValue":e[11]||(e[11]=t=>D.value=t),width:"600px",onClosed:Z},{footer:s(()=>[l(r,{onClick:we},{default:s(()=>e[21]||(e[21]=[g("取消")])),_:1}),l(r,{type:"primary",onClick:ke},{default:s(()=>e[22]||(e[22]=[g("确定")])),_:1})]),default:s(()=>[l(M,{ref_key:"formRef",ref:K,model:o,rules:me,"label-width":"100px"},{default:s(()=>[l(d,{label:"用户名",prop:"username"},{default:s(()=>[l(n,{modelValue:o.username,"onUpdate:modelValue":e[3]||(e[3]=t=>o.username=t),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),C.value==="add"?(k(),$(d,{key:0,label:"密码",prop:"password"},{default:s(()=>[l(n,{modelValue:o.password,"onUpdate:modelValue":e[4]||(e[4]=t=>o.password=t),placeholder:"请输入密码",type:"password"},null,8,["modelValue"])]),_:1})):ue("",!0),l(d,{label:"姓名",prop:"descr"},{default:s(()=>[l(n,{modelValue:o.descr,"onUpdate:modelValue":e[5]||(e[5]=t=>o.descr=t),placeholder:"请输入姓名"},null,8,["modelValue"])]),_:1}),l(d,{label:"部门",prop:"departmentid"},{default:s(()=>[l(N,{modelValue:o.departmentid,"onUpdate:modelValue":e[6]||(e[6]=t=>o.departmentid=t),placeholder:"请选择部门"},{default:s(()=>[(k(!0),O(Be,null,Re(E.value,t=>(k(),$(V,{key:t.code,label:t.name,value:t.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(d,{label:"岗位",prop:"category"},{default:s(()=>[l(n,{modelValue:o.category,"onUpdate:modelValue":e[7]||(e[7]=t=>o.category=t),placeholder:"请输入岗位名称"},null,8,["modelValue"])]),_:1}),l(d,{label:"手机号",prop:"phone"},{default:s(()=>[l(n,{modelValue:o.phone,"onUpdate:modelValue":e[8]||(e[8]=t=>o.phone=t),placeholder:"请输入手机号"},null,8,["modelValue"])]),_:1}),l(d,{label:"状态",prop:"status"},{default:s(()=>[l(N,{modelValue:o.status,"onUpdate:modelValue":e[9]||(e[9]=t=>o.status=t),placeholder:"请选择状态"},{default:s(()=>[l(V,{label:"正常",value:0}),l(V,{label:"删除",value:-1})]),_:1},8,["modelValue"])]),_:1}),l(d,{label:"头像",prop:"avatar"},{default:s(()=>[q("div",Qe,[l(f,{ref_key:"avatarUpload",ref:A,"auto-upload":!1,"on-change":ye,"on-remove":he,limit:1,accept:"image/*","file-list":U.value},{default:s(()=>[l(r,{type:"primary"},{default:s(()=>e[20]||(e[20]=[g("上传头像")])),_:1})]),_:1},8,["file-list"]),x.value?(k(),$(S,{key:0,src:x.value,style:{width:"100px",height:"100px","margin-top":"10px","border-radius":"8px"},fit:"cover"},null,8,["src"])):(k(),O("span",Xe,"暂无头像"))])]),_:1}),l(d,{label:"备注",prop:"memo"},{default:s(()=>[l(n,{modelValue:o.memo,"onUpdate:modelValue":e[10]||(e[10]=t=>o.memo=t),type:"textarea",placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),l(z,{title:"权限设置",modelValue:P.value,"onUpdate:modelValue":e[13]||(e[13]=t=>P.value=t),width:"600px",onClosed:Ce,"destroy-on-close":""},{footer:s(()=>[l(r,{onClick:e[12]||(e[12]=t=>P.value=!1)},{default:s(()=>e[25]||(e[25]=[g("关闭")])),_:1})]),default:s(()=>[y.id?(k(),O("div",Ye,[q("p",null,[e[23]||(e[23]=g("为用户 ")),q("strong",null,oe(y.username),1),e[24]||(e[24]=g(" 设置菜单权限："))]),ne((k(),$(B,{ref_key:"menuTreeRef",ref:R,data:b.value,"show-checkbox":"","node-key":"id",props:{label:"title",children:"children"},key:te.value,onCheck:ve,"default-expand-all":!0,"check-strictly":!0},null,8,["data"])),[[G,J.value]])])):ue("",!0)]),_:1},8,["modelValue"])])}}},sa=Ie(Ze,[["__scopeId","data-v-3f6830e7"]]);export{sa as default};

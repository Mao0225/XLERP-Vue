import{O as L,P as Te,Q as Me,R as $e,_ as We,f as Le,g as J,r as p,k as Be,s as Oe,h as g,G as Qe,o as w,c as C,a as S,b as a,e as _,w as r,i as f,x as Y,a6 as qe,H as ie,l as ue,F as de,m as pe,ai as ce,q as Je,p as Ye,E as y,A as Ee,B as Ke}from"./index-DivwvCM9.js";import{a as Ie}from"./file-DG1x66KO.js";import{W as Pe}from"./WoNoSelector-BU9BVcDC.js";import{g as Ae}from"./basorg-CEO7C1K8.js";import"./plshengchangongdan-x5Bc9PHG.js";function He(m){return L("/clnzxjFc/getpage",m)}function Ge(m){return L("/clnzxjFc/get",m)}function Xe(m){return Te("/clnzxjFc/save",m)}function Ze(m){return Me("/clnzxjFc/update",m)}function ea(m){return $e("/clnzxjFc/delete",m)}function aa(m){return L("/clnzxjFc/getWoNoList",m)}function me(m){return L("/Basno/getNewNoNyName",{basname:m})}const ta={class:"nzxjFc-management"},la={class:"action-bar"},oa=["onClick"],ra={class:"pagination-container"},na={key:0,class:"uploaded-files"},sa=["onClick"],ia={class:"pagination-container"},ua={__name:"nzxjfc",setup(m){const fe=Ke,U=Le(),E=()=>(console.log("获取登录用户名称",U.descr),U.descr),i=J({mafactory:"",maQuality:"",orderno:"",matRecheckNo:"",pageNumber:1,pageSize:10}),K=p([]),I=p(0),B=p(!1),V=p(!1),P=p([]),A=p(0),O=p(!1),h=p(!1),H=p([]),G=p(0),Q=p(!1),N=J({descr:"",type:1,pageNumber:1,pageSize:10}),k=p(!1),F=p("add"),ge=Be(()=>F.value==="add"?"新增数据":"编辑数据"),z=p(null),R=p(null),j=p([]),l=J({id:void 0,contractNo:"",woNo:"",ipoNo:"",mafactory:"",maQuality:"",orderno:"",matRecheckNo:"",sampleNumber:"",testResult:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",writeTime:"",writer:E(),status:0,isdelete:0,basno:""}),ye={mafactory:[{required:!0,message:"请选择原材料制造商",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],maQuality:[{required:!0,message:"请输入辅材类型",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],orderno:[{required:!0,message:"请输入入库单号",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],matRecheckNo:[{required:!0,message:"请输入来料检测批测号",trigger:"blur"},{max:50,message:"长度不能超过50个字符",trigger:"blur"}],sampleNumber:[{required:!0,message:"请输入样品编号",trigger:"blur"}],testResult:[{required:!0,message:"请输入检测结果",trigger:"blur"}],leavefactoryDate:[{required:!0,message:"请输入出厂日期",trigger:"change"}],detectionTime:[{required:!0,message:"请输入入厂日期",trigger:"change"}],contractNo:[{required:!0,message:"长度不能超过50个字符",trigger:"blur"}],woNo:[{max:50,message:"长度不能超过50个字符",trigger:"blur"}],ipoNo:[{max:50,message:"长度不能超过50个字符",trigger:"blur"}],basno:[{max:50,message:"请获取单据号",trigger:"blur"}]},X=()=>{h.value=!0,x()},x=async()=>{Q.value=!0;try{const o=await Ae(N);H.value=o.data.page.list,G.value=o.data.page.totalRow}catch(o){console.error("获取供应商列表失败",o),y.error("获取供应商列表失败")}finally{Q.value=!1}},Ne=o=>{N.pageSize=o,x()},be=o=>{N.pageNumber=o,x()},Z=o=>{l.mafactory=o.descr,l.mafactoryId=o.id,h.value=!1},ve=o=>{Z(o)},D=p(""),ee=()=>{D.value="woNo",V.value=!0,T()},ae=()=>{D.value="contractNo",V.value=!0,T()},te=()=>{D.value="ipoNo",V.value=!0,T()},we=o=>{switch(D.value){case"contractNo":l.contractNo=o.contractNo||"";break;case"woNo":l.woNo=o.woNo||"";break;case"ipoNo":l.ipoNo=o.ipoNo||"";break}V.value=!1},T=async(o="")=>{O.value=!0;try{const e=await aa({pageNumber:1,pageSize:10,woNo:o});P.value=e.data.page.list,A.value=e.data.page.totalRow}catch(e){console.error("获取合同号列表失败",e),y.error("获取合同号列表失败")}finally{O.value=!1}},c=async()=>{B.value=!0;try{const o=await He(i);K.value=o.data.page.list,I.value=o.data.page.totalRow}catch(o){console.error("获取数据列表失败",o),y.error("获取数据列表失败")}finally{B.value=!1}},Ve=o=>{i.pageSize=o,c()},ke=o=>{i.pageNumber=o,c()},le=()=>{z.value&&z.value.resetFields(),R.value&&R.value.clearFiles(),j.value=[],Object.assign(l,{id:void 0,contractNo:"",woNo:"",ipoNo:"",mafactory:"",mafactoryId:"",maQuality:"",orderno:"",matRecheckNo:"",sampleNumber:"",testResult:"",leavefactoryDate:"",detectionTime:"",certificate:"[]",writeTime:"",writer:E(),status:0,isdelete:0,basno:""})},Ce=()=>{i.contractNo="",i.woNo="",i.ipoNo="",i.mafactory="",i.maQuality="",i.orderno="",i.matRecheckNo="",i.pageNumber=1,c()},ze=async()=>{F.value="add",le(),l.writer=U.descr||"未知用户";try{if(M.value)l.basno=M.value,M.value="";else{const o=await me("nzxjfc");o.code===200?l.basno=o.data.fullNoNyName:y.warning("获取单据号失败，可手动填写")}}catch(o){console.error("获取单据号异常",o),y.error("获取单据号失败")}k.value=!0},xe=async o=>{F.value="edit";const e=await Ge({id:o.id});Object.assign(l,e.data.nzxjFc),l.writer||(l.writer=U.descr||"未知用户");try{JSON.parse(l.certificate)}catch{if(l.certificate){const u=l.certificate.split("-");l.certificate=JSON.stringify(u.map(b=>({name:b.split("/").pop(),url:`/api/upload/${b}`})))}else l.certificate="[]"}j.value=JSON.parse(l.certificate),k.value=!0},Se=o=>{Ee.confirm(`确认删除数据"${o.no}"吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ea({id:o.id}),y.success("删除成功"),c()}catch(e){console.error("删除数据失败",e),y.error("删除数据失败")}}).catch(()=>{})},_e=()=>{z.value&&z.value.validate(async o=>{if(o)try{if(!l.basno){y.error("单据号未生成，请刷新重试");return}const e=new Date,n=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),b=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),$=String(e.getMinutes()).padStart(2,"0"),W=String(e.getSeconds()).padStart(2,"0");if(l.writeTime=`${n}-${u}-${b} ${s}:${$}:${W}`,F.value==="add"){await Xe(l),y.success("新增成功");try{const d=await me("nzxjfc");d.code===200&&(M.value=d.data.fullNoNyName)}catch(d){console.error("获取新单据号异常",d)}}else await Ze(l),y.success("修改成功");k.value=!1,c()}catch(e){console.error("保存数据失败",e),y.error("保存数据失败")}})},M=p(""),Ue=async o=>{const e=new FormData;e.append("file",o.raw);try{const n=await Ie(e);if(n.success&&n.data&&n.data.url){const u=fe+n.data.url,b=JSON.parse(l.certificate);b.push({name:o.name,url:u}),l.certificate=JSON.stringify(b),j.value.push({name:o.name,url:u}),y.success(`${o.name} 上传成功`)}else throw new Error(n.msg||"文件上传失败")}catch(n){console.error("文件上传失败",n),y.error(`${o.name} 上传失败`),R.value.clearFiles()}},he=o=>{const e=JSON.parse(l.certificate);e.splice(o,1),l.certificate=JSON.stringify(e),j.value.splice(o,1)},oe=o=>{window.open(o,"_blank")};return Oe(()=>{c()}),(o,e)=>{const n=g("el-input"),u=g("el-button"),b=g("el-icon"),s=g("el-table-column"),$=g("el-table"),W=g("el-pagination"),d=g("el-form-item"),re=g("el-date-picker"),Fe=g("el-upload"),Re=g("el-col"),je=g("el-row"),De=g("el-form"),ne=g("el-dialog"),se=Qe("loading");return w(),C("div",ta,[S("div",la,[a(n,{modelValue:i.mafactory,"onUpdate:modelValue":e[0]||(e[0]=t=>i.mafactory=t),placeholder:"请输入原材料制造商查询",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),a(n,{modelValue:i.maQuality,"onUpdate:modelValue":e[1]||(e[1]=t=>i.maQuality=t),placeholder:"请输入辅材类型",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),a(n,{modelValue:i.orderno,"onUpdate:modelValue":e[2]||(e[2]=t=>i.orderno=t),placeholder:"请输入入库单号查询",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),a(n,{modelValue:i.matRecheckNo,"onUpdate:modelValue":e[3]||(e[3]=t=>i.matRecheckNo=t),placeholder:"请输入来料检验批次号",style:{width:"200px","margin-right":"10px"},clearable:"",onClear:c,onKeyup:_(c,["enter"])},null,8,["modelValue"]),a(u,{type:"primary",onClick:c},{default:r(()=>e[26]||(e[26]=[f("搜索")])),_:1}),a(u,{type:"warning",onClick:Ce},{default:r(()=>[a(b,null,{default:r(()=>[a(Y(qe))]),_:1}),e[27]||(e[27]=f(" 刷新 "))]),_:1}),a(u,{type:"primary",style:{"margin-left":"auto"},onClick:ze},{default:r(()=>e[28]||(e[28]=[f("新增")])),_:1})]),ie((w(),ue($,{data:K.value,border:"",style:{width:"100%"}},{default:r(()=>[a(s,{type:"index",label:"序号",width:"80"}),a(s,{prop:"basno",label:"单据号"}),a(s,{prop:"contractNo",label:"合同编号"}),a(s,{prop:"woNo",label:"生产工单号"}),a(s,{prop:"ipoNo",label:"生产订单号"}),a(s,{prop:"writer",label:"录入人"}),a(s,{prop:"writeTime",label:"录入时间"}),a(s,{prop:"mafactory",label:"原材料制造商"}),a(s,{prop:"maQuality",label:"辅材类型"}),a(s,{prop:"orderno",label:"入库单号"}),a(s,{prop:"matRecheckNo",label:"来料检验批次号"}),a(s,{prop:"sampleNumber",label:"样品编号"}),a(s,{prop:"testResult",label:"检测结果"}),a(s,{prop:"leavefactoryDate",label:"原材料出厂检测日期",width:"120"}),a(s,{prop:"detectionTime",label:"原材料入厂检测日期",width:"120"}),a(s,{prop:"certificate",label:"质量证明书"},{default:r(({row:t})=>[(w(!0),C(de,null,pe(JSON.parse(t.certificate||"[]"),(v,q)=>(w(),C("div",{key:q},[a(Y(ce),{content:v.name,placement:"top"},{default:r(()=>[S("span",{class:"file-link",onClick:da=>oe(v.url,v.name)}," 打开文件 ",8,oa)]),_:2},1032,["content"])]))),128))]),_:1}),a(s,{label:"操作",width:"200"},{default:r(({row:t})=>[a(u,{type:"primary",size:"small",onClick:v=>xe(t)},{default:r(()=>e[29]||(e[29]=[f("编辑")])),_:2},1032,["onClick"]),a(u,{type:"danger",size:"small",onClick:v=>Se(t)},{default:r(()=>e[30]||(e[30]=[f("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[se,B.value]]),S("div",ra,[a(W,{"current-page":i.pageNumber,"onUpdate:currentPage":e[4]||(e[4]=t=>i.pageNumber=t),"page-size":i.pageSize,"onUpdate:pageSize":e[5]||(e[5]=t=>i.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:I.value,onSizeChange:Ve,onCurrentChange:ke},null,8,["current-page","page-size","total"])]),a(ne,{title:ge.value,modelValue:k.value,"onUpdate:modelValue":e[20]||(e[20]=t=>k.value=t),width:"800px",onClosed:le},{footer:r(()=>[a(u,{onClick:e[19]||(e[19]=t=>k.value=!1)},{default:r(()=>e[37]||(e[37]=[f("取消")])),_:1}),a(u,{type:"primary",onClick:_e},{default:r(()=>e[38]||(e[38]=[f("确定")])),_:1})]),default:r(()=>[a(De,{ref_key:"formRef",ref:z,model:l,rules:ye,"label-width":"140px"},{default:r(()=>[a(je,{gutter:20},{default:r(()=>[a(Re,{span:12},{default:r(()=>[a(d,{label:"合同编号",prop:"contractNo"},{default:r(()=>[a(n,{modelValue:l.contractNo,"onUpdate:modelValue":e[6]||(e[6]=t=>l.contractNo=t),placeholder:"选择合同编号",readonly:"",onClick:ae},{append:r(()=>[a(u,{onClick:ae,size:"small"},{default:r(()=>e[31]||(e[31]=[f("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"生产工单号",prop:"woNo"},{default:r(()=>[a(n,{modelValue:l.woNo,"onUpdate:modelValue":e[7]||(e[7]=t=>l.woNo=t),placeholder:"选择生产工单号",readonly:"",onClick:ee},{append:r(()=>[a(u,{onClick:ee,size:"small"},{default:r(()=>e[32]||(e[32]=[f("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"生产订单号",prop:"ipoNo"},{default:r(()=>[a(n,{modelValue:l.ipoNo,"onUpdate:modelValue":e[8]||(e[8]=t=>l.ipoNo=t),placeholder:"选择生产订单号",readonly:"",onClick:te},{append:r(()=>[a(u,{onClick:te,size:"small"},{default:r(()=>e[33]||(e[33]=[f("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"录入人",prop:"writer"},{default:r(()=>[a(n,{modelValue:l.writer,"onUpdate:modelValue":e[9]||(e[9]=t=>l.writer=t),placeholder:"录入人",readonly:""},null,8,["modelValue"])]),_:1}),a(d,{label:"单据号",prop:"basno"},{default:r(()=>[a(n,{modelValue:l.basno,"onUpdate:modelValue":e[10]||(e[10]=t=>l.basno=t),placeholder:"自动生成",readonly:""},null,8,["modelValue"])]),_:1}),a(d,{label:"原材料制造商",prop:"mafactory"},{default:r(()=>[a(n,{modelValue:l.mafactory,"onUpdate:modelValue":e[11]||(e[11]=t=>l.mafactory=t),placeholder:"选择原材料制造商",readonly:"",onClick:X},{append:r(()=>[a(u,{onClick:X,size:"small"},{default:r(()=>e[34]||(e[34]=[f("选择")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"辅材类型",prop:"maQuality"},{default:r(()=>[a(n,{modelValue:l.maQuality,"onUpdate:modelValue":e[12]||(e[12]=t=>l.maQuality=t),placeholder:"请输入辅材类型"},null,8,["modelValue"])]),_:1}),a(d,{label:"入库单号",prop:"orderno"},{default:r(()=>[a(n,{modelValue:l.orderno,"onUpdate:modelValue":e[13]||(e[13]=t=>l.orderno=t),placeholder:"请输入入库单号"},null,8,["modelValue"])]),_:1}),a(d,{label:"来料检验批次号",prop:"matRecheckNo"},{default:r(()=>[a(n,{modelValue:l.matRecheckNo,"onUpdate:modelValue":e[14]||(e[14]=t=>l.matRecheckNo=t),placeholder:"请输入来料检验批次号"},null,8,["modelValue"])]),_:1}),a(d,{label:"样品编号",prop:"sampleNumber"},{default:r(()=>[a(n,{modelValue:l.sampleNumber,"onUpdate:modelValue":e[15]||(e[15]=t=>l.sampleNumber=t),placeholder:"请输入样品编号"},null,8,["modelValue"])]),_:1}),a(d,{label:"检测结果",prop:"testResult"},{default:r(()=>[a(n,{modelValue:l.testResult,"onUpdate:modelValue":e[16]||(e[16]=t=>l.testResult=t),placeholder:"请输入检测结果"},null,8,["modelValue"])]),_:1}),a(d,{label:"原材料出厂检测日期",prop:"leavefactoryDate"},{default:r(()=>[a(re,{modelValue:l.leavefactoryDate,"onUpdate:modelValue":e[17]||(e[17]=t=>l.leavefactoryDate=t),type:"date",placeholder:"请选择原材料出厂检测日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(d,{label:"原材料入厂检测日期",prop:"detectionTime"},{default:r(()=>[a(re,{modelValue:l.detectionTime,"onUpdate:modelValue":e[18]||(e[18]=t=>l.detectionTime=t),type:"date",placeholder:"请选择原材料入厂检测日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(d,{label:"质量证明书",prop:"certificate"},{default:r(()=>[a(Fe,{ref_key:"certificateUpload",ref:R,"auto-upload":!1,"on-change":Ue,limit:10,accept:".pdf,.jpg,.jpeg,.png","file-list":[],"show-file-list":!1},{default:r(()=>[a(u,{type:"primary"},{default:r(()=>e[35]||(e[35]=[f("上传文件")])),_:1})]),_:1},512),l.certificate?(w(),C("div",na,[(w(!0),C(de,null,pe(JSON.parse(l.certificate),(t,v)=>(w(),C("div",{key:v,class:"uploaded-file"},[a(Y(ce),{content:t.name,placement:"top"},{default:r(()=>[S("span",{class:"file-link",onClick:q=>oe(t.url,t.name)},Je(t.name),9,sa)]),_:2},1032,["content"]),a(u,{type:"danger",size:"mini",onClick:q=>he(v)},{default:r(()=>e[36]||(e[36]=[f("删除")])),_:2},1032,["onClick"])]))),128))])):Ye("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),a(Pe,{modelValue:V.value,"onUpdate:modelValue":e[21]||(e[21]=t=>V.value=t),onSelect:we,woNoList:P.value,totalWoNo:A.value,loadingWoNo:O.value,onSearch:T},null,8,["modelValue","woNoList","totalWoNo","loadingWoNo"]),a(ne,{title:"选择原材料制造商",modelValue:h.value,"onUpdate:modelValue":e[25]||(e[25]=t=>h.value=t),width:"600px"},{default:r(()=>[a(n,{modelValue:N.descr,"onUpdate:modelValue":e[22]||(e[22]=t=>N.descr=t),placeholder:"请输入供应商名称查询",style:{"margin-bottom":"10px"},clearable:"",onClear:x,onKeyup:_(x,["enter"])},null,8,["modelValue"]),ie((w(),ue($,{data:H.value,border:"",style:{width:"100%"},onRowClick:ve},{default:r(()=>[a(s,{prop:"no",label:"供应商编号"}),a(s,{prop:"descr",label:"供应商名称"}),a(s,{prop:"contactname",label:"联系人"}),a(s,{prop:"phone",label:"联系电话"}),a(s,{label:"操作"},{default:r(({row:t})=>[a(u,{type:"primary",size:"small",onClick:v=>Z(t)},{default:r(()=>e[39]||(e[39]=[f("选择")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[se,Q.value]]),S("div",ia,[a(W,{"current-page":N.pageNumber,"onUpdate:currentPage":e[23]||(e[23]=t=>N.pageNumber=t),"page-size":N.pageSize,"onUpdate:pageSize":e[24]||(e[24]=t=>N.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:G.value,onSizeChange:Ne,onCurrentChange:be},null,8,["current-page","page-size","total"])])]),_:1},8,["modelValue"])])}}},ya=We(ua,[["__scopeId","data-v-d956ae38"]]);export{ya as default};
